<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="icon" href="./favicon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReliefNote - 遺族のためのGPS</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-warm: #f8f7f4;
            --text-primary: #1a1a1a;
            --text-secondary: #6b6b6b;
            --text-tertiary: #999999;
            --accent: #3F453F;
            --accent-light: #ededed;
            --warning: #c45a3c;
            --warning-light: #fef0ec;
            --border: #e8e8e8;
            --border-light: #f0f0f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            font-size: clamp(14px, 3.8vw, 15px);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-secondary);
            -webkit-font-smoothing: antialiased;
            padding-bottom: calc(52px + env(safe-area-inset-bottom));
        }

        .app-container {
            max-width: 430px;
            width: 100%;
            margin: 0 auto;
            background: var(--bg-warm);
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
        }

        .screen {
            display: none;
            animation: fadeInScreen 0.2s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeInScreen {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Typography */
        .heading-xl { font-size: clamp(22px, 6vw, 28px); font-weight: 700; letter-spacing: -0.5px; }
        .heading-lg { font-size: clamp(18px, 5vw, 22px); font-weight: 700; letter-spacing: -0.3px; }
        .heading-md { font-size: clamp(15px, 4vw, 17px); font-weight: 600; }
        .heading-sm { font-size: 15px; font-weight: 600; }
        .body-md { font-size: clamp(14px, 3.8vw, 15px); font-weight: 400; color: var(--text-primary); }
        .body-sm { font-size: 13px; font-weight: 400; color: var(--text-secondary); }
        .caption { font-size: 12px; font-weight: 400; color: var(--text-tertiary); }

        /* Buttons */
        .btn-primary {
            display: block;
            width: 100%;
            height: 48px;
            padding: 0 16px;
            background: var(--accent);
            color: #ffffff;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-primary:active { opacity: 0.85; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            display: block;
            width: 100%;
            height: 48px;
            padding: 0 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
        }

        /* Card */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 16px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-open { background: var(--accent-light); color: var(--accent); }
        .badge-confirm { background: var(--warning-light); color: var(--warning); }
        .badge-done { background: var(--bg-secondary); color: var(--text-tertiary); }
        .badge-blocked { background: var(--bg-secondary); color: var(--text-tertiary); }
        .badge-deadline { background: var(--warning-light); color: var(--warning); }

        .badge-domain {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        /* 画面0: スプラッシュ */
        .splash-screen {
            background: var(--bg-warm);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 16px;
            text-align: center;
        }

        .splash-icon {
            font-size: 56px;
            margin-bottom: 20px;
        }

        .splash-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
        }

        .splash-logo-fallback {
            display: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent);
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .splash-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .splash-tagline {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .splash-message {
            font-size: 18px;
            font-weight: 500;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 40px;
        }

        .btn-splash {
            width: 100%;
            max-width: 320px;
        }

        .splash-footer {
            position: absolute;
            bottom: 32px;
            font-size: 12px;
            color: var(--text-tertiary);
            text-align: center;
        }

        /* 画面1: オンボーディング（質問） */
        .question-header {
            padding: 20px 16px;
            display: flex;
            align-items: center;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-primary);
            padding: 8px;
        }

        .question-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px 16px;
            margin: 0 16px 24px;
        }

        .domain-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 16px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .question-text {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin-bottom: 16px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .question-info {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .option-btn {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.15s;
            color: var(--text-primary);
        }

        .option-btn:active {
            opacity: 0.7;
        }

        .option-btn.selected {
            background: var(--accent-light);
            border-color: var(--accent);
            font-weight: 600;
            color: var(--accent);
        }

        .date-input {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        .skip-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--text-tertiary);
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* Name input within question flow */
        .name-input-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 8px;
            max-width: 280px;
            margin: 0 auto;
        }

        .name-input-form .question-text {
            text-align: center;
            margin-bottom: 8px;
        }

        .name-input-form .question-info {
            text-align: center;
            margin-bottom: 32px;
        }

        .name-input {
            width: 100%;
            padding: 16px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-size: 17px;
            text-align: center;
            outline: none;
            transition: border-color 0.15s;
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
        }

        .name-input:focus {
            border-color: var(--accent);
        }

        .name-input::placeholder {
            color: var(--text-tertiary);
        }

        .name-input-actions {
            width: 100%;
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .btn-skip-name {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            text-decoration: none;
        }

        /* 画面2: ホーム */
        #screen-home {
            background: var(--bg-warm);
        }

        .home-header {
            background: var(--bg-primary);
            padding: 32px 16px 28px;
            border-bottom: 1px solid var(--border-light);
        }

        .header-top {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .model-badge {
            display: none;
        }

        .share-btn {
            display: none;
        }

        .header-greeting {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .header-name {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
            display: inline-block;
        }

        .header-weeks {
            float: right;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 6px 0;
        }

        .home-progress {
            margin-top: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .unanswered-questions-card {
            margin: 0 16px 24px;
            background: var(--bg-warm);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .unanswered-questions-card:active {
            opacity: 0.7;
        }

        .unanswered-questions-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .unanswered-questions-action {
            font-size: 13px;
            color: var(--accent);
            font-weight: 600;
            white-space: nowrap;
        }

        .settings-icon-btn {
            color: var(--text-tertiary);
        }

        .home-section {
            padding: 24px 16px;
        }

        .home-today-section {
            padding: 24px 16px 0;
        }

        .home-today-card {
            background: #ffffff;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .home-consult-section {
            padding: 0 16px;
            margin-bottom: calc(44px + 24px + env(safe-area-inset-bottom));
        }

        .consult-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: clamp(15px, 4vw, 17px);
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .consult-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .consult-card:active {
            opacity: 0.9;
        }

        .consult-main-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .consult-sub-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 4px;
        }

        .consult-button {
            margin-top: 14px;
            background: var(--accent);
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 0;
            width: 100%;
            border: none;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .consult-button:active {
            opacity: 0.8;
        }

        .section-title-count {
            color: var(--text-tertiary);
            font-size: 13px;
            font-weight: 400;
            margin-left: 8px;
        }

        .task-card-small {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }

        /* 今日やることセクション内のタスクカード */
        #todayTasks .task-item {
            background: transparent;
            border: none;
            border-radius: 0;
            border-bottom: 1px solid var(--border-light);
            padding: 12px 0;
            margin-bottom: 0;
        }

        #todayTasks .task-item:last-child {
            border-bottom: none;
        }

        #todayTasks .task-checkbox {
            width: 22px;
            height: 22px;
            min-width: 22px;
            margin-right: 12px;
        }

        #todayTasks .task-checkbox:checked::after {
            left: 6px;
            top: 2px;
            width: 6px;
            height: 11px;
        }

        #todayTasks .task-name {
            font-size: 14px;
            line-height: 1.5;
        }

        #todayTasks .task-status-hint {
            font-size: 12px;
            margin-top: 2px;
        }

        #todayTasks .task-status-hint.need-confirm {
            color: var(--accent);
        }

        #todayTasks .task-status-hint.blocked {
            color: var(--text-tertiary);
        }

        #todayTasks .task-deadline-display {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        #todayTasks .task-deadline-display.warning {
            color: var(--warning);
        }

        .consultation-card {
            display: none;
        }

        .consultation-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .online-status {
            font-size: 13px;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .online-status::before {
            content: "●";
            margin-right: 4px;
        }

        .consultation-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .btn-consult {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-consult-primary {
            background: var(--accent);
            color: white;
        }

        .btn-consult-secondary {
            background: var(--bg-primary);
            color: var(--accent);
            border: 1px solid var(--border);
        }

        .consultation-note {
            font-size: 11px;
            color: var(--text-tertiary);
            text-align: center;
        }

        .link-to-confirm {
            display: block;
            text-align: center;
            color: var(--text-tertiary);
            text-decoration: none;
            cursor: pointer;
            margin-top: 24px;
            font-size: 14px;
        }

        /* 画面3: おくやみガイド */
        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 32px 16px 20px;
            background: var(--bg-primary);
        }

        .guide-title {
            font-size: clamp(22px, 6vw, 28px);
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .calendar-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            transition: all 0.2s;
        }

        .calendar-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .calendar-btn svg {
            width: 16px;
            height: 16px;
            fill: var(--text-secondary);
        }

        .guide-tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
        }

        #guideContent {
            transition: opacity 0.2s ease;
            background: var(--bg-warm);
        }

        .tab-btn {
            padding: 6px 16px;
            background: transparent;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 400;
            color: var(--text-tertiary);
            transition: all 0.15s ease;
            font-size: 15px;
        }

        .tab-btn.active {
            color: var(--text-primary);
            background: var(--accent-light);
            font-weight: 600;
        }

        .btn-filter-questions {
            margin: 12px 16px;
            width: calc(100% - 32px);
            background: var(--bg-warm);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: opacity 0.15s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-filter-questions-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .btn-filter-questions-action {
            font-size: 13px;
            color: var(--accent);
            font-weight: 600;
        }

        .btn-filter-questions:active {
            opacity: 0.7;
        }

        .phase-section {
            margin: 12px 16px;
        }

        .phase-header {
            background: var(--bg-primary);
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            transition: background 0.2s ease;
        }

        .phase-header:active {
            background: var(--bg-secondary);
        }

        .phase-arrow {
            transition: transform 0.2s ease;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .phase-section.open .phase-arrow {
            transform: rotate(180deg);
        }

        .phase-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .phase-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-count-badge {
            background: var(--accent-light);
            color: var(--accent);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .phase-tasks {
            display: none;
            padding-top: 12px;
        }

        .phase-section.open .phase-tasks {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .completed-tasks-section {
            margin-top: 12px;
        }

        .completed-tasks-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            color: var(--text-tertiary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            border-radius: 12px;
        }

        .completed-tasks-header:active {
            background: var(--border-light);
        }

        .completed-tasks-list {
            display: none;
            padding-top: 12px;
        }

        .completed-tasks-section.open .completed-tasks-list {
            display: block;
            animation: slideDown 0.2s ease;
        }

        .completed-arrow {
            transition: transform 0.2s ease;
            font-size: 12px;
        }

        .completed-tasks-section.open .completed-arrow {
            transform: rotate(180deg);
        }

        .task-item {
            background: var(--bg-primary);
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease;
        }

        .task-item:active {
            background: var(--bg-secondary);
        }

        .task-item:last-child {
            margin-bottom: 0;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            min-width: 20px;
            min-height: 20px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            border: 2px solid var(--border);
            border-radius: 50%;
            background: var(--bg-primary);
            position: relative;
            transition: all 0.2s ease;
            margin-top: 2px;
        }

        .task-checkbox:checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        .task-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .task-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .task-name {
            font-size: 15px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .task-deadline {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .task-confirm-hint {
            font-size: 13px;
            color: var(--accent);
        }

        .task-name.done {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        /* 画面4: タスク詳細 */
        #screen-detail {
            background: var(--bg-warm);
            animation: fadeInDetail 0.2s ease;
        }

        @keyframes fadeInDetail {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .detail-header {
            height: 48px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            background: transparent;
        }

        .detail-back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 15px;
            cursor: pointer;
            padding: 8px 12px 8px 0;
            min-width: 44px;
            min-height: 44px;
        }

        .detail-content {
            max-width: 430px;
            padding: 0 16px calc(44px + 48px + 32px + env(safe-area-inset-bottom));
            margin: 0 auto;
        }

        .detail-title-area {
            margin-bottom: 8px;
        }

        .detail-task-title {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .detail-status-badge {
            display: inline-block;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 8px;
        }

        .detail-status-badge.open,
        .detail-status-badge.done {
            display: none;
        }

        .detail-status-badge.confirm {
            background: #fff3cd;
            color: #856d0a;
        }

        .detail-status-badge.blocked {
            background: #f0f0f0;
            color: #999999;
        }

        .detail-summary-text {
            margin-top: 8px;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .detail-deadline {
            margin-top: 16px;
            margin-bottom: 24px;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1.5px solid var(--border-light);
            background: var(--bg-primary);
        }

        .detail-deadline-main {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.6;
        }

        .detail-deadline-label {
            color: var(--text-secondary);
        }

        .detail-deadline-date {
            color: var(--text-primary);
        }

        .detail-deadline-remaining {
            color: var(--text-secondary);
        }

        .detail-deadline-remaining.urgent {
            color: var(--warning);
            font-weight: 600;
        }

        .detail-deadline-remaining.soon {
            color: #b8860b;
            font-weight: 600;
        }

        .detail-deadline-remaining.overdue {
            color: var(--warning);
            font-weight: 600;
        }

        .detail-deadline-sub {
            margin-top: 4px;
            font-size: 12px;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .detail-deadline-sub.link {
            color: var(--accent);
            cursor: pointer;
        }

        /* 期限超過 - 赤背景 */
        .detail-deadline.overdue-warning {
            background: var(--warning-light);
            border-color: var(--warning);
        }

        .detail-deadline.overdue-warning .detail-deadline-main {
            color: var(--warning);
        }

        .detail-deadline.overdue-warning .detail-deadline-label {
            color: var(--warning);
        }

        .detail-deadline.overdue-warning .detail-deadline-sub {
            color: var(--text-secondary);
        }

        /* 緊急（7日以内） - オレンジ背景 */
        .detail-deadline.urgent-warning {
            background: #fff4e6;
            border-color: #ff9800;
        }

        .detail-deadline.urgent-warning .detail-deadline-label {
            color: #e65100;
        }

        .detail-deadline.urgent-warning .detail-deadline-date {
            color: #e65100;
        }

        /* 注意（14日以内） - 薄い黄色背景 */
        .detail-deadline.soon-warning {
            background: #fffbf0;
            border-color: #ffc107;
        }

        .detail-deadline.soon-warning .detail-deadline-label {
            color: #f57c00;
        }

        .detail-deadline.soon-warning .detail-deadline-date {
            color: #f57c00;
        }

        /* 未回答（死亡日未入力） - アクセントカラー */
        .detail-deadline.no-date {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .detail-deadline.no-date .detail-deadline-label,
        .detail-deadline.no-date .detail-deadline-main {
            color: var(--accent);
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .detail-section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .detail-white-card {
            background: #ffffff;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 16px;
        }

        .detail-why-text {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .detail-dest-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .detail-dest-address {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .detail-dest-phone {
            font-size: 14px;
            color: var(--accent);
            text-decoration: none;
            margin-bottom: 4px;
            display: block;
        }

        .detail-dest-hours {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .detail-docs-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .detail-docs-list li {
            font-size: 14px;
            line-height: 2.0;
            color: var(--text-primary);
            padding-left: 16px;
            position: relative;
        }

        .detail-docs-list li::before {
            content: '●';
            position: absolute;
            left: 0;
            color: var(--accent);
            font-size: 8px;
            top: 7px;
        }

        .detail-steps-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .detail-step-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 16px 0;
            border-bottom: 1px dashed var(--border-light);
        }

        .detail-step-item:last-child {
            border-bottom: none;
        }

        .detail-step-checkbox {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            min-width: 18px;
            min-height: 18px;
            margin-top: 3px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            border: 1.5px solid var(--border);
            border-radius: 50%;
            background: var(--bg-primary);
            position: relative;
            transition: all 0.2s ease;
        }

        .detail-step-checkbox:checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        .detail-step-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 1px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 1.5px 1.5px 0;
            transform: rotate(45deg);
        }

        .detail-step-number {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            background: var(--accent-light);
            color: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .detail-step-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            transition: color 0.2s ease;
        }

        .detail-step-item.completed .detail-step-text {
            color: var(--text-tertiary);
        }

        .detail-done-text {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-primary);
            border-left: 3px solid var(--accent);
            padding-left: 16px;
        }

        .detail-faq-item {
            border-bottom: 1px solid var(--border-light);
            overflow: hidden;
        }

        .detail-faq-item:last-child {
            border-bottom: none;
        }

        .detail-faq-question {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 12px 0;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .detail-faq-arrow {
            font-size: 12px;
            color: var(--text-tertiary);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .detail-faq-item.open .detail-faq-arrow {
            transform: rotate(180deg);
        }

        .detail-faq-answer {
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-secondary);
            padding: 0;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
        }

        .detail-faq-item.open .detail-faq-answer {
            max-height: 1000px;
            opacity: 1;
            padding: 0 0 12px 0;
        }

        .detail-preparing {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .detail-footer {
            position: fixed;
            bottom: calc(52px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            max-width: 430px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-top: 1px solid var(--border-light);
            z-index: 100;
        }

        .btn-complete {
            width: 100%;
            height: 48px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }

        .btn-complete.active {
            background: var(--accent);
            color: white;
        }

        .btn-complete.done {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .btn-complete:active {
            opacity: 0.85;
        }

        /* 画面5: 確認センター */
        .confirm-new-header {
            height: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
        }

        .confirm-back-btn,
        .confirm-exit-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 15px;
            cursor: pointer;
            padding: 8px;
        }

        .confirm-center-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .confirm-progress-container {
            background: var(--bg-primary);
            padding: 0 16px 16px;
        }

        .confirm-progress-bar {
            width: 100%;
            height: 2px;
            background: var(--border-light);
            border-radius: 1px;
            overflow: hidden;
        }

        .confirm-progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .confirm-progress-text {
            font-size: 13px;
            color: var(--text-tertiary);
            text-align: center;
            margin-top: 8px;
        }

        .confirm-question-area {
            padding: 16px;
            background: var(--bg-warm);
            min-height: calc(100vh - 56px - 80px);
            min-height: calc(100dvh - 56px - 80px);
        }

        .confirm-question-slide {
            animation: slideInRight 0.2s ease;
        }

        .confirm-question-slide-left {
            animation: slideInLeft 0.2s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .confirm-completion-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 56px - 80px);
            padding: 40px 20px;
            background: var(--bg-warm);
        }

        .confirm-completion-content {
            max-width: 360px;
            width: 100%;
        }

        /* 画面6: ナレッジ */
        .knowledge-content {
            padding: 32px 24px;
        }

        .knowledge-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .qa-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .qa-question {
            padding: 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
        }

        .qa-answer {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .qa-card.open .qa-answer {
            padding: 0 20px 20px;
            max-height: 500px;
        }

        /* 画面6: その他（設定） */
        .settings-content {
            padding: 0;
            background: var(--bg-warm);
            min-height: 100vh;
            padding-bottom: calc(52px + 80px + env(safe-area-inset-bottom));
        }

        .settings-header {
            background: var(--bg-primary);
            padding: 32px 16px 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-section {
            background: var(--bg-primary);
            margin-bottom: 24px;
            padding: 16px;
        }

        .settings-section-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-label {
            font-size: 15px;
            color: var(--text-primary);
        }

        .settings-item-value {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .btn-edit {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 15px;
            cursor: pointer;
            padding: 0;
        }

        .btn-danger {
            width: 100%;
            background: transparent;
            color: var(--warning);
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
        }

        .settings-footer {
            text-align: center;
            padding: 40px 16px;
            color: var(--text-tertiary);
            font-size: 12px;
            line-height: 1.8;
        }

        /* モーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: 16px 16px 0 0;
            padding: 24px 16px;
            max-width: 430px;
            width: 100%;
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .modal-input {
            width: 100%;
            padding: 16px;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            font-size: 17px;
            outline: none;
            transition: border-color 0.15s;
            margin-bottom: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
        }

        .modal-input:focus {
            border-color: var(--accent);
        }

        /* ダイアログ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog-overlay.show {
            display: flex;
        }

        .dialog {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px 16px;
            max-width: 320px;
            width: calc(100% - 32px);
            text-align: center;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .dialog-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .dialog-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .dialog-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn-dialog-confirm {
            width: 100%;
            padding: 14px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-dialog-cancel {
            width: 100%;
            padding: 14px;
            background: transparent;
            color: var(--text-tertiary);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        /* フローティング相談ボタン */
        .floating-consult-btn {
            position: fixed;
            bottom: calc(52px + 12px + env(safe-area-inset-bottom));
            right: 16px;
            z-index: 300;
            height: 44px;
            padding: 0 16px;
            border-radius: 22px;
            background: var(--accent);
            color: white;
            font-size: 13px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.15s ease;
        }

        .floating-consult-btn.show {
            display: flex;
        }

        .floating-consult-btn:active {
            transform: scale(0.95);
        }

        /* フッターナビ */
        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
            display: flex;
            height: 52px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 200;
        }

        .nav-item {
            width: 33.33%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-tertiary);
            transition: color 0.15s;
        }

        .nav-item.active {
            color: var(--text-primary);
        }

        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .nav-icon svg {
            width: 24px;
            height: 24px;
        }

        .nav-label {
            display: none;
        }

        /* ホーム画面の歯車アイコン */
        .settings-icon-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 10px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 画面7: 遺族コンシェルジュ */
        .concierge-content {
            padding: 24px 16px calc(44px + 24px + env(safe-area-inset-bottom));
            background: var(--bg-warm);
        }

        /* エリア1: 感情的メッセージ */
        .concierge-hero {
            margin-bottom: 24px;
        }

        .concierge-hero-main {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .concierge-hero-sub {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* エリア2: LINEで相談するボタン */
        .concierge-line-button {
            background: var(--accent);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 24px;
            transition: opacity 0.15s;
        }

        .concierge-line-button:active {
            opacity: 0.9;
        }

        .concierge-line-icon {
            flex-shrink: 0;
        }

        .concierge-line-content {
            flex: 1;
        }

        .concierge-line-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .concierge-line-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* エリア3: 担当者紹介 */
        .concierge-staff-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .concierge-staff-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .concierge-staff-info {
            flex: 1;
        }

        .concierge-staff-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .concierge-staff-role {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* エリア4: 相談例 */
        .concierge-topics-section {
            margin-bottom: 24px;
        }

        .concierge-topics-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .concierge-topics-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 16px;
        }

        .concierge-topic-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            line-height: 2.0;
        }

        .concierge-topic-bullet {
            font-size: 6px;
            color: var(--accent);
            flex-shrink: 0;
            margin-top: 8px;
        }

        .concierge-topic-text {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        /* エリア5: 利用者の声 */
        .concierge-testimonial-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 14px 16px;
        }

        .concierge-testimonial-quote {
            font-size: 32px;
            color: var(--border);
            line-height: 1;
            margin-bottom: 4px;
        }

        .concierge-testimonial-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.7;
            font-style: normal;
            margin-bottom: 8px;
        }

        .concierge-testimonial-source {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            z-index: 1000;
            display: none;
            max-width: 90%;
            font-size: 15px;
        }

        .toast.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* カレンダー画面 */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .calendar-back-btn {
            position: absolute;
            left: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 15px;
            cursor: pointer;
            padding: 8px;
        }

        .calendar-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .overdue-summary {
            margin: 16px 20px;
            background: var(--warning-light);
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .overdue-text {
            font-size: 14px;
            color: var(--warning);
            font-weight: 500;
        }

        .btn-expand {
            background: none;
            border: none;
            color: var(--warning);
            font-size: 12px;
            cursor: pointer;
            padding: 4px;
        }

        .overdue-tasks-list {
            margin: 0 20px 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .calendar-no-date {
            margin: 40px 20px;
            padding: 32px 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            text-align: center;
        }

        .calendar-container {
            padding: 16px 20px;
        }

        .calendar-month-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .month-nav-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            padding: 8px 14px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .month-nav-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .calendar-month-label {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .calendar-grid {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-bottom: 12px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            padding: 10px 0;
            letter-spacing: 0.5px;
        }

        .calendar-dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .calendar-date-cell {
            min-height: 72px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 4px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-date-cell:hover:not(.other-month) {
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .calendar-date-cell.selected {
            background: var(--accent-light);
            border: 2px solid var(--accent);
            box-shadow: 0 2px 8px rgba(63, 69, 63, 0.15);
        }

        .calendar-date-cell.other-month {
            opacity: 0.2;
            pointer-events: none;
        }

        .calendar-date-number {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .calendar-date-cell.past:not(.today) .calendar-date-number {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .calendar-date-cell.today .calendar-date-number {
            background: var(--accent);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(63, 69, 63, 0.3);
        }

        .calendar-date-dots {
            display: flex;
            gap: 4px;
            margin-top: auto;
        }

        .calendar-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .calendar-dot.overdue {
            background: var(--warning);
        }

        .calendar-dot.done {
            background: var(--text-tertiary);
            opacity: 0.5;
        }

        .selected-date-tasks {
            margin: 16px 20px;
            padding-bottom: 80px;
        }

        .selected-date-header {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .selected-date-tasks .task-item {
            margin-bottom: 8px;
        }

        .selected-date-no-tasks {
            text-align: center;
            color: var(--text-tertiary);
            font-size: 14px;
            padding: 32px 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calendar-dates {
            animation: fadeIn 0.2s ease;
        }

        .selected-date-tasks {
            animation: slideDown 0.2s ease;
        }

        @media (min-width: 431px) {
            .app-container {
                border-left: 1px solid var(--border-light);
                border-right: 1px solid var(--border-light);
            }
        }

        /* 360px以下（小型Android） */
        @media (max-width: 360px) {
            body {
                padding-left: 12px;
                padding-right: 12px;
            }

            .heading-xl {
                font-size: 22px;
            }

            .option-btn {
                font-size: 13px;
                padding: 8px 12px;
            }

            .card,
            .task-card-small,
            .concierge-contact-card,
            .concierge-topics-list,
            .concierge-testimonial,
            .detail-white-card,
            .detail-summary-card {
                padding: 12px 14px;
            }

            .home-header,
            .guide-header,
            .concierge-header,
            .settings-header,
            .question-header,
            .detail-header,
            .confirm-new-header,
            .confirm-progress-container,
            .confirm-question-area {
                padding-left: 12px;
                padding-right: 12px;
            }

            .home-section,
            .concierge-section {
                padding-left: 12px;
                padding-right: 12px;
            }

            .question-card {
                margin-left: 12px;
                margin-right: 12px;
                padding: 20px 14px;
            }

            .settings-section {
                padding: 14px 12px;
            }

            .floating-consult-btn {
                right: 12px;
            }

            .floating-consult-btn span:last-child {
                display: none;
            }

            .floating-consult-btn {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                padding: 0;
                justify-content: center;
            }
        }

        /* 394px〜430px（iPhone Plus/Pro Max） */
        @media (min-width: 394px) {
            .home-section,
            .concierge-section,
            .detail-section {
                margin-bottom: 28px;
            }

            .card,
            .task-card-small,
            .concierge-contact-card,
            .concierge-topics-list,
            .concierge-testimonial,
            .detail-white-card,
            .detail-summary-card {
                padding: 16px 20px;
            }

            .concierge-intro-card {
                padding: 24px 20px;
            }

            .heading-xl {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>
    <div class="app-container">
        <!-- 画面0: スプラッシュ -->
        <div id="screen-splash" class="screen active">
            <div class="splash-screen">
                <img
                    src="./logo.png"
                    alt="ReliefNote"
                    class="splash-logo"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                >
                <div class="splash-logo-fallback">R</div>
                <div class="splash-title">ReliefNote</div>
                <div class="splash-tagline">遺族のためのGPS</div>
                <div class="splash-message">悲しみの中でも、<br>迷わず前へ。</div>
                <button class="btn-splash btn-primary" onclick="startOnboarding()">はじめる</button>
                <div class="splash-footer">
                    © ReliefNote Inc.
                </div>
            </div>
        </div>

        <!-- 画面1: オンボーディング（質問） -->
        <div id="screen-onboarding" class="screen">
            <div class="question-header">
                <button class="back-btn" onclick="prevQuestion()">＜</button>
            </div>
            <div class="question-card" id="questionCard"></div>
        </div>

        <!-- 画面2: ホーム -->
        <div id="screen-home" class="screen">
            <div class="home-header">
                <div class="header-top">
                    <span class="model-badge">📍 北竜町モデル</span>
                    <button class="settings-icon-btn" onclick="showScreen('screen-settings')">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                </div>
                <div class="header-greeting" id="greetingText">こんにちは、</div>
                <div>
                    <span class="header-name">田中さん</span>
                    <span class="header-weeks" id="weeksDisplay">--週目</span>
                </div>
                <div class="home-progress" id="homeProgress"></div>
            </div>

            <div class="home-today-section">
                <div class="home-today-card">
                    <div class="section-title">今日やること</div>
                    <div id="todayTasks"></div>
                </div>
            </div>

            <div id="unansweredQuestionsCard" class="unanswered-questions-card" onclick="showScreen('screen-confirm')" style="display: none;"></div>

            <div class="home-consult-section">
                <div class="consult-section-title">サポート</div>
                <div class="consult-card" onclick="showScreen('screen-concierge')">
                    <div class="consult-main-text">一人で抱え込まないでください</div>
                    <div class="consult-sub-text">手続きや気持ちのこと、いつでもご相談ください</div>
                    <button class="consult-button">相談する</button>
                </div>
            </div>
        </div>

        <!-- 画面3: おくやみガイド -->
        <div id="screen-guide" class="screen">
            <div class="guide-header">
                <div class="guide-title">おくやみガイド</div>
                <button class="calendar-btn" onclick="showCalendar()">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
                        <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    カレンダー
                </button>
            </div>
            <div class="guide-tabs">
                <button class="tab-btn active" onclick="setGuideView('phase')">期限順</button>
                <button class="tab-btn" onclick="setGuideView('domain')">行き先順</button>
            </div>
            <button class="btn-filter-questions" onclick="showScreen('screen-confirm')">
                <span class="btn-filter-questions-text">質問に答えて、あなた専用に絞り込み</span>
                <span class="btn-filter-questions-action">回答する ›</span>
            </button>
            <div id="guideContent"></div>
        </div>

        <!-- 画面4: タスク詳細 -->
        <div id="screen-detail" class="screen">
            <div class="detail-header">
                <button class="detail-back-btn" onclick="showScreen('screen-guide')">← 戻る</button>
            </div>
            <div class="detail-content" id="detailContent"></div>
            <div class="detail-footer">
                <button class="btn-complete" id="completeBtn" onclick="completeCurrentTask()">完了にする</button>
            </div>
        </div>

        <!-- 画面5: 確認センター -->
        <div id="screen-confirm" class="screen">
            <div class="confirm-new-header">
                <button class="confirm-back-btn" onclick="prevConfirmQuestion()">← 戻る</button>
                <span class="confirm-center-title">確認センター</span>
                <button class="confirm-exit-btn" onclick="exitConfirmCenter()">終了</button>
            </div>
            <div class="confirm-progress-container">
                <div class="confirm-progress-bar">
                    <div class="confirm-progress-fill" id="confirmProgressFill"></div>
                </div>
                <div class="confirm-progress-text" id="confirmProgressText">1 / 19</div>
            </div>
            <div class="confirm-question-area" id="confirmQuestionArea"></div>
            <div id="confirmCompletionScreen" class="confirm-completion-screen" style="display: none;">
                <div class="confirm-completion-content">
                    <div class="heading-lg" style="text-align: center; margin-bottom: 16px;">確認が完了しました</div>
                    <div class="body-sm" style="text-align: center; color: var(--text-secondary); margin-bottom: 40px;">回答内容はいつでも変更できます</div>
                    <button class="btn-primary" onclick="showScreen('screen-home')">ホームへ戻る</button>
                </div>
            </div>
        </div>

        <!-- 画面6: その他（設定） -->
        <div id="screen-settings" class="screen">
            <div class="settings-header">
                <div class="heading-xl">その他</div>
            </div>
            <div class="settings-content">
                <!-- アカウントセクション -->
                <div class="settings-section">
                    <div class="settings-section-title">アカウント</div>
                    <div class="settings-item">
                        <span class="settings-item-label" id="displayUserName">田中さん</span>
                        <button class="btn-edit" onclick="showEditNameModal()">編集</button>
                    </div>
                </div>

                <!-- よくある質問セクション -->
                <div class="settings-section">
                    <div class="settings-section-title">よくある質問</div>
                    <div>
                        <div class="qa-card" onclick="toggleQA(this)">
                            <div class="qa-question">Q. 相続放棄の期限は？ <span>▼</span></div>
                            <div class="qa-answer">死亡を知った日から3ヶ月以内に家庭裁判所へ申述する必要があります。</div>
                        </div>
                        <div class="qa-card" onclick="toggleQA(this)">
                            <div class="qa-question">Q. 銀行口座の凍結とは？ <span>▼</span></div>
                            <div class="qa-answer">銀行が口座名義人の死亡を知ると、口座が凍結され入出金ができなくなります。相続手続きが完了するまで解除されません。</div>
                        </div>
                        <div class="qa-card" onclick="toggleQA(this)">
                            <div class="qa-question">Q. 死亡届は誰が出せる？ <span>▼</span></div>
                            <div class="qa-answer">同居の親族、その他の親族、同居者などが届出できます。届出期限は死亡の事実を知った日から7日以内です。</div>
                        </div>
                        <div class="qa-card" onclick="toggleQA(this)">
                            <div class="qa-question">Q. 遺族年金はいくらもらえる？ <span>▼</span></div>
                            <div class="qa-answer">遺族基礎年金は子のある配偶者に年約80万円＋子の加算。遺族厚生年金は故人の報酬比例額の3/4。受給要件は年金事務所で確認してください。</div>
                        </div>
                        <div class="qa-card" onclick="toggleQA(this)">
                            <div class="qa-question">Q. 準確定申告とは？ <span>▼</span></div>
                            <div class="qa-answer">亡くなった方の所得税の確定申告を、相続人が代わりに行うことです。死亡から4ヶ月以内に税務署へ申告します。</div>
                        </div>
                    </div>
                </div>

                <!-- データ管理セクション -->
                <div class="settings-section">
                    <div class="settings-section-title">データ管理</div>
                    <button class="btn-secondary" onclick="resetAnswers()">回答をやり直す</button>
                    <div style="margin-top: 16px;">
                        <button class="btn-danger" onclick="showLogoutDialog()">すべてのデータを削除してログアウト</button>
                    </div>
                </div>

                <!-- フッター -->
                <div class="settings-footer">
                    データはこの端末にのみ保存されています<br>
                    © 2026 ReliefNote Inc.
                </div>
            </div>
        </div>

        <!-- 画面7: 遺族コンシェルジュ -->
        <div id="screen-concierge" class="screen">
            <div class="concierge-content">
                <!-- エリア1: 感情的メッセージ -->
                <div class="concierge-hero">
                    <div class="concierge-hero-main">一人で抱え込まないでください。</div>
                    <div class="concierge-hero-sub">手続きのことも、気持ちのことも、<br>いつでもご相談ください。</div>
                </div>

                <!-- エリア2: LINEで相談するボタン -->
                <div class="concierge-line-button" onclick="openLineOA()">
                    <div class="concierge-line-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="concierge-line-content">
                        <div class="concierge-line-title">LINEで相談する</div>
                        <div class="concierge-line-subtitle">トークでいつでも・返信は原則24時間以内</div>
                    </div>
                </div>

                <!-- エリア3: 担当者紹介 -->
                <div class="concierge-staff-card">
                    <div class="concierge-staff-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="concierge-staff-info">
                        <div class="concierge-staff-name">北林 歩</div>
                        <div class="concierge-staff-role">遺族支援コンシェルジュ</div>
                    </div>
                </div>

                <!-- エリア4: 相談例 -->
                <div class="concierge-topics-section">
                    <div class="concierge-topics-title">こんなことを相談できます</div>
                    <div class="concierge-topics-card">
                        <div class="concierge-topic-item">
                            <div class="concierge-topic-bullet">●</div>
                            <div class="concierge-topic-text">何から手をつければいいか分からない</div>
                        </div>
                        <div class="concierge-topic-item">
                            <div class="concierge-topic-bullet">●</div>
                            <div class="concierge-topic-text">役場の手続きで必要な書類を教えてほしい</div>
                        </div>
                        <div class="concierge-topic-item">
                            <div class="concierge-topic-bullet">●</div>
                            <div class="concierge-topic-text">相続のことを誰に相談すればいいか</div>
                        </div>
                        <div class="concierge-topic-item">
                            <div class="concierge-topic-bullet">●</div>
                            <div class="concierge-topic-text">気持ちの整理がつかず辛い</div>
                        </div>
                        <div class="concierge-topic-item">
                            <div class="concierge-topic-bullet">●</div>
                            <div class="concierge-topic-text">家族で手続きをどう分担すればいいか</div>
                        </div>
                    </div>
                </div>

                <!-- エリア5: 利用者の声 -->
                <div class="concierge-testimonial-card">
                    <div class="concierge-testimonial-quote">"</div>
                    <div class="concierge-testimonial-text">人に相談できることが一番ありがたかった</div>
                    <div class="concierge-testimonial-source">ユーザーインタビューより</div>
                </div>
            </div>
        </div>

        <!-- 画面8: カレンダー -->
        <div id="screen-calendar" class="screen">
            <div class="calendar-header">
                <button class="calendar-back-btn" onclick="showScreen('screen-guide')">← 戻る</button>
                <span class="calendar-title">カレンダー</span>
            </div>

            <!-- 期限切れサマリー -->
            <div id="overdueTasksSummary" class="overdue-summary" style="display: none;">
                <div class="overdue-text" id="overdueText">期限を過ぎたタスクが3件あります</div>
                <button class="btn-expand" onclick="toggleOverdueTasks()">▼</button>
            </div>
            <div id="overdueTasksList" class="overdue-tasks-list" style="display: none;"></div>

            <!-- 死亡日未入力メッセージ -->
            <div id="calendarNoDateMessage" class="calendar-no-date" style="display: none;">
                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                    亡くなった日を入力すると、期限が表示されます
                </div>
                <button class="btn-primary" onclick="goToDeathDateQuestion()">入力する</button>
            </div>

            <!-- カレンダー本体 -->
            <div id="calendarContainer" class="calendar-container">
                <!-- 月ナビゲーション -->
                <div class="calendar-month-nav">
                    <button class="month-nav-btn" onclick="changeMonth(-1)">＜</button>
                    <span class="calendar-month-label" id="calendarMonthLabel">2026年2月</span>
                    <button class="month-nav-btn" onclick="changeMonth(1)">＞</button>
                </div>

                <!-- カレンダーグリッド -->
                <div class="calendar-grid">
                    <!-- 曜日ヘッダー -->
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">日</div>
                        <div class="calendar-weekday">月</div>
                        <div class="calendar-weekday">火</div>
                        <div class="calendar-weekday">水</div>
                        <div class="calendar-weekday">木</div>
                        <div class="calendar-weekday">金</div>
                        <div class="calendar-weekday">土</div>
                    </div>

                    <!-- 日付セル -->
                    <div class="calendar-dates" id="calendarDates">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
            </div>

            <!-- 選択日のタスクリスト -->
            <div id="selectedDateTasks" class="selected-date-tasks" style="display: none;">
                <div class="selected-date-header" id="selectedDateHeader">2月15日（土）のタスク</div>
                <div id="selectedDateTasksList"></div>
            </div>
        </div>

        <!-- 名前変更モーダル -->
        <div id="editNameModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-title">名前を変更</div>
                <input type="text" id="editNameInput" class="modal-input" placeholder="名前を入力" maxlength="20">
                <button class="btn-primary" onclick="saveEditedName()">保存</button>
            </div>
        </div>

        <!-- ログアウト確認ダイアログ -->
        <div id="logoutDialog" class="dialog-overlay">
            <div class="dialog">
                <div class="dialog-title">ログアウトしますか？</div>
                <div class="dialog-message">すべてのデータ（回答・完了状況）が削除されます。この操作は取り消せません。</div>
                <div class="dialog-actions">
                    <button class="btn-dialog-confirm" onclick="confirmLogout()">ログアウトする</button>
                    <button class="btn-dialog-cancel" onclick="closeLogoutDialog()">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- 回答リセット確認ダイアログ -->
        <div id="resetDialog" class="dialog-overlay">
            <div class="dialog">
                <div class="dialog-title">回答をリセットしますか？</div>
                <div class="dialog-message">質問への回答をリセットしますか？タスクの完了状況は保持されます。</div>
                <div class="dialog-actions">
                    <button class="btn-dialog-confirm" onclick="confirmResetAnswers()">リセットする</button>
                    <button class="btn-dialog-cancel" onclick="closeResetDialog()">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- フローティング相談ボタン -->
        <button class="floating-consult-btn" id="floatingConsultBtn" onclick="openLineOA()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>相談する</span>
        </button>

        <!-- フッターナビ -->
        <div class="footer-nav">
            <button class="nav-item active" onclick="switchTab('home')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="nav-label">ホーム</div>
            </button>
            <button class="nav-item" onclick="switchTab('guide')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 5H7C6.46957 5 5.96086 5.21071 5.58579 5.58579C5.21071 5.96086 5 6.46957 5 7V19C5 19.5304 5.21071 20.0391 5.58579 20.4142C5.96086 20.7893 6.46957 21 7 21H17C17.5304 21 18.0391 20.7893 18.4142 20.4142C18.7893 20.0391 19 19.5304 19 19V7C19 6.46957 18.7893 5.96086 18.4142 5.58579C18.0391 5.21071 17.5304 5 17 5H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 5C9 4.46957 9.21071 3.96086 9.58579 3.58579C9.96086 3.21071 10.4696 3 11 3H13C13.5304 3 14.0391 3.21071 14.4142 3.58579C14.7893 3.96086 15 4.46957 15 5C15 5.53043 14.7893 6.03914 14.4142 6.41421C14.0391 6.78929 13.5304 7 13 7H11C10.4696 7 9.96086 6.78929 9.58579 6.41421C9.21071 6.03914 9 5.53043 9 5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 16H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="nav-label">ガイド</div>
            </button>
            <button class="nav-item" onclick="switchTab('concierge')">
                <div class="nav-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="nav-label">相談</div>
            </button>
        </div>
    </div>

    <script>
        // LINE公式アカウントURL（変更可能）
        const LINE_OA_URL = 'https://line.me/R/ti/p/@158uksjs#~';

        // アコーディオンの開閉状態を保持（メモリのみ、localStorageには保存しない）
        window._accordionState = window._accordionState || {};
        // スクロール位置を保持
        window._guideScrollTop = window._guideScrollTop || 0;

        // データ定義（既存のものを維持）
        const questions = [
            { id: "Q-REL-01", domain: "ADMIN", text: "亡くなられた方とのご関係を教えてください", type: "single", options: [
                {value: "SPOUSE", label: "配偶者（夫・妻）"},
                {value: "CHILD", label: "子"},
                {value: "PARENT", label: "親"},
                {value: "SIBLING", label: "兄弟姉妹"},
                {value: "OTHER_RELATIVE", label: "その他の親族"},
                {value: "NON_RELATIVE", label: "親族以外"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-DOD-01", domain: "ADMIN", text: "お亡くなりになった日を教えてください", type: "date" },
            { id: "Q-DIG-01", domain: "DIGITAL", text: "故人名義の携帯電話・ネット回線・サブスク・SNS等のアカウントはありますか？", type: "multi", options: [
                {value: "MOBILE", label: "携帯電話"},
                {value: "NET", label: "ネット回線"},
                {value: "SUBSCRIPTIONS", label: "サブスクリプション"},
                {value: "ACCOUNTS", label: "SNS・その他アカウント"},
                {value: "NONE", label: "なし"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-FUN-STATUS-01", domain: "FUNERAL", text: "葬儀の状況を教えてください", type: "single", options: [
                {value: "NOT_DECIDED", label: "まだ決まっていない"},
                {value: "ARRANGING", label: "手配中"},
                {value: "SCHEDULED", label: "日程決定済み"},
                {value: "COMPLETED", label: "葬儀は済んだ"},
                {value: "DIRECT_CREMATION", label: "直葬にした"},
                {value: "NO_FUNERAL", label: "葬儀は行わない"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-ADMIN-DN-01", domain: "ADMIN", text: "死亡届は提出されましたか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "IN_PROGRESS", label: "手続き中"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-EMP-01", domain: "EMPLOYMENT", text: "あなた（届出をする方）は現在、勤務先がありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-DECEASED-EMP-01", domain: "EMPLOYMENT", text: "故人はお亡くなりになった時点で勤務先がありましたか？（パート・アルバイト含む）", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-HOUSEHOLD-01", domain: "ADMIN", text: "故人は世帯主でしたか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-HI-01", domain: "PENSION", text: "故人の健康保険はどれですか？", type: "single", options: [
                {value: "NHI", label: "国民健康保険"},
                {value: "EHI", label: "社会保険（会社の健康保険）"},
                {value: "LATTER", label: "後期高齢者医療制度"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-DEPENDENT-01", domain: "PENSION", text: "故人の健康保険の扶養に入っていた方はいますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-CARE-01", domain: "PENSION", text: "故人は介護保険サービスを受けていましたか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-PEN-01", domain: "PENSION", text: "故人は年金を受給していましたか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-PEN-EMP-01", domain: "PENSION", text: "故人に厚生年金または共済年金の加入歴はありそうですか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-SPOUSE-01", domain: "PENSION", text: "故人に配偶者（夫または妻）はいますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"}
            ]},
            { id: "Q-CHILD-U18-01", domain: "PENSION", text: "18歳到達年度末までのお子さんはいますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"}
            ]},
            { id: "Q-FIN-01", domain: "FINANCE", text: "故人名義の金融関連の契約はありますか？", type: "multi", options: [
                {value: "BANK", label: "銀行口座"},
                {value: "CARD", label: "クレジットカード"},
                {value: "SECURITIES", label: "証券口座"},
                {value: "NONE", label: "なし"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-INS-01", domain: "INSURANCE", text: "故人が加入していた民間保険はありますか？", type: "multi", options: [
                {value: "LIFE", label: "生命保険"},
                {value: "MEDICAL", label: "医療保険"},
                {value: "COOP", label: "共済"},
                {value: "NONE", label: "なし"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-INS-DAMAGE-01", domain: "INSURANCE", text: "故人名義の損害保険（自動車保険・火災保険など）はありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-UTIL-01", domain: "HOUSING", text: "故人名義の電気・ガス・水道の契約はありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-RENT-01", domain: "HOUSING", text: "故人名義の賃貸住宅の契約はありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-WILL-01", domain: "INHERITANCE", text: "遺言書は見つかっていますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-AGRI-01", domain: "INHERITANCE", text: "故人名義の農地（田・畑）はありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-LOAN-01", domain: "FINANCE", text: "故人名義の住宅ローン・借入金はありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-TAX-01", domain: "TAX", text: "故人に収入はありましたか？（複数選択可）", type: "multi", options: [
                {value: "SALARY", label: "給与"},
                {value: "PENSION", label: "年金"},
                {value: "BUSINESS", label: "事業収入"},
                {value: "REALESTATE", label: "不動産収入"},
                {value: "NONE", label: "なし"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-RE-01", domain: "INHERITANCE", text: "故人名義の不動産（土地・建物）はありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]},
            { id: "Q-CAR-01", domain: "CAR", text: "故人名義の自動車はありますか？", type: "single", options: [
                {value: "YES", label: "はい"},
                {value: "NO", label: "いいえ"},
                {value: "UNKNOWN", label: "わからない"}
            ]}
        ];

        const tasks = [
            {id:"RN-H24-01", title:"死亡診断書を受け取る", domain:"ADMIN", phase:"H24", priority:95, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-H24-02", title:"死亡診断書をコピーする（5部以上推奨）", domain:"ADMIN", phase:"H24", priority:85, dependsOn:["RN-H24-01"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-H24-03", title:"ご遺体の搬送・安置先を手配する", domain:"FUNERAL", phase:"H24", priority:98, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-H24-04", title:"貴重品（通帳・印鑑・証券等）を保管する", domain:"ADMIN", phase:"H24", priority:90, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-H24-05", title:"故人宅の戸締まりを確認する", domain:"HOUSING", phase:"H24", priority:80, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-H24-06", title:"喪主を決める", domain:"FUNERAL", phase:"H24", priority:70, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-H24-11", title:"故人のスマホ・PCを保全する（電源維持）", domain:"DIGITAL", phase:"H24", priority:88, dependsOn:[], requiredQuestions:["Q-DIG-01"], ruleType:"CONFIRMED", appliesWhen:"Q-DIG-01.containsAny('MOBILE','NET','SUBSCRIPTIONS','ACCOUNTS')", notApplicableWhen:"Q-DIG-01.includes('NONE')", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D7-01", title:"葬儀社を決める", domain:"FUNERAL", phase:"D7", priority:85, dependsOn:["RN-H24-03"], requiredQuestions:["Q-FUN-STATUS-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:"Q-FUN-STATUS-01=='COMPLETED'", fallbackStatus:"OPEN"},
            {id:"RN-D7-02", title:"葬儀の日程・式場・形式・予算を決める", domain:"FUNERAL", phase:"D7", priority:85, dependsOn:["RN-D7-01"], requiredQuestions:["Q-FUN-STATUS-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:"Q-FUN-STATUS-01=='COMPLETED'", fallbackStatus:"OPEN"},
            {id:"RN-D7-04", title:"訃報を連絡する", domain:"FUNERAL", phase:"D7", priority:65, dependsOn:["RN-D7-02"], requiredQuestions:["Q-FUN-STATUS-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:"['COMPLETED','NO_FUNERAL'].includes(Q-FUN-STATUS-01)", fallbackStatus:"OPEN"},
            {id:"RN-D7-05", title:"遺影写真を準備する", domain:"FUNERAL", phase:"D7", priority:60, dependsOn:["RN-D7-02"], requiredQuestions:["Q-FUN-STATUS-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:"['COMPLETED','NO_FUNERAL'].includes(Q-FUN-STATUS-01)", fallbackStatus:"OPEN"},
            {id:"RN-D7-06", title:"死亡届を提出し火葬許可証を取得する【届出期限7日】", domain:"ADMIN", phase:"D7", priority:100, dependsOn:["RN-H24-01"], requiredQuestions:["Q-ADMIN-DN-01"], ruleType:"CONFIRMED", appliesWhen:"['NO','IN_PROGRESS','UNKNOWN'].includes(Q-ADMIN-DN-01)", notApplicableWhen:"Q-ADMIN-DN-01=='YES'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D7-07", title:"埋葬許可証を保管する（火葬後）", domain:"ADMIN", phase:"D7", priority:80, dependsOn:["RN-D7-06"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D7-10", title:"【口座凍結前】直近の引落し予定を確認する", domain:"FINANCE", phase:"D7", priority:90, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D7-11", title:"役場でまとめてできる手続きを確認する", domain:"ADMIN", phase:"D7", priority:75, dependsOn:["RN-D7-06"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D7-12", title:"自分の勤務先へ届出をする（忌引休暇・弔慰金・団体保険等の確認）", domain:"EMPLOYMENT", phase:"D7", priority:75, dependsOn:[], requiredQuestions:["Q-EMP-01"], ruleType:"CONFIRMED", appliesWhen:"Q-EMP-01=='YES'", notApplicableWhen:"Q-EMP-01=='NO'", fallbackStatus:"OPEN"},
            {id:"RN-D7-13", title:"故人の住民票の除票を取得する", domain:"ADMIN", phase:"D7", priority:78, dependsOn:["RN-D7-06"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D7-14", title:"故人の勤務先へ届出をする（退職手続き・死亡退職金・貸与品返却等）", domain:"EMPLOYMENT", phase:"D7", priority:80, dependsOn:[], requiredQuestions:["Q-DECEASED-EMP-01"], ruleType:"CONFIRMED", appliesWhen:"Q-DECEASED-EMP-01=='YES'", notApplicableWhen:"Q-DECEASED-EMP-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-01", title:"世帯主変更届を提出する【届出期限14日】", domain:"ADMIN", phase:"D14", priority:85, dependsOn:["RN-D7-06"], requiredQuestions:["Q-HOUSEHOLD-01"], ruleType:"CONFIRMED", appliesWhen:"Q-HOUSEHOLD-01=='YES'", notApplicableWhen:"Q-HOUSEHOLD-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-02", title:"健康保険の資格喪失届を提出する【届出期限14日】", domain:"HEALTH", phase:"D14", priority:90, dependsOn:["RN-D7-06"], requiredQuestions:["Q-HI-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-03", title:"葬祭費・埋葬料を申請する（約5万円）", domain:"HEALTH", phase:"D14", priority:85, dependsOn:["RN-D7-06"], requiredQuestions:["Q-HI-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-04", title:"高額療養費の還付申請を確認する", domain:"HEALTH", phase:"D14", priority:70, dependsOn:["RN-D7-06"], requiredQuestions:["Q-HI-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-05", title:"介護保険の届出と最終精算を確認する", domain:"HEALTH", phase:"D14", priority:70, dependsOn:[], requiredQuestions:["Q-CARE-01"], ruleType:"CONFIRMED", appliesWhen:"Q-CARE-01=='YES'", notApplicableWhen:"Q-CARE-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-06", title:"年金受給停止届を提出する【届出期限14日】※厚生年金は10日以内", domain:"PENSION", phase:"D14", priority:90, dependsOn:["RN-D7-06"], requiredQuestions:["Q-PEN-01"], ruleType:"CONFIRMED", appliesWhen:"Q-PEN-01=='YES'", notApplicableWhen:"Q-PEN-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-07", title:"未支給年金を請求する", domain:"PENSION", phase:"D14", priority:75, dependsOn:["RN-D14-06"], requiredQuestions:["Q-PEN-01"], ruleType:"CONFIRMED", appliesWhen:"Q-PEN-01=='YES'", notApplicableWhen:"Q-PEN-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-08", title:"遺族年金の受給資格を確認する", domain:"PENSION", phase:"D14", priority:85, dependsOn:["RN-D7-06"], requiredQuestions:["Q-SPOUSE-01","Q-CHILD-U18-01","Q-PEN-EMP-01","Q-PEN-01"], ruleType:"CONFIRMED", appliesWhen:"Q-SPOUSE-01=='YES'||Q-CHILD-U18-01=='YES'||Q-PEN-EMP-01=='YES'||Q-PEN-01=='YES'", notApplicableWhen:"Q-SPOUSE-01=='NO'&&Q-CHILD-U18-01=='NO'&&Q-PEN-EMP-01=='NO'&&Q-PEN-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-09", title:"銀行へ死亡を届け出る", domain:"FINANCE", phase:"D14", priority:88, dependsOn:["RN-D7-06","RN-D7-10"], requiredQuestions:["Q-FIN-01"], ruleType:"CONFIRMED", appliesWhen:"Q-FIN-01.containsAny('BANK')", notApplicableWhen:"Q-FIN-01.includes('NONE')", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-10", title:"証券口座の届出・名義変更をする", domain:"FINANCE", phase:"D14", priority:75, dependsOn:["RN-D7-06"], requiredQuestions:["Q-FIN-01"], ruleType:"CONFIRMED", appliesWhen:"Q-FIN-01.containsAny('SECURITIES')", notApplicableWhen:"Q-FIN-01.includes('NONE')", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-11", title:"生命保険の死亡保険金を請求する", domain:"INSURANCE", phase:"D14", priority:85, dependsOn:["RN-D7-06"], requiredQuestions:["Q-INS-01"], ruleType:"CONFIRMED", appliesWhen:"Q-INS-01.containsAny('LIFE','MEDICAL','COOP')", notApplicableWhen:"Q-INS-01.includes('NONE')", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-12", title:"損害保険（自動車保険・火災保険等）の届出・名義変更をする", domain:"INSURANCE", phase:"D14", priority:70, dependsOn:[], requiredQuestions:["Q-INS-DAMAGE-01"], ruleType:"CONFIRMED", appliesWhen:"Q-INS-DAMAGE-01=='YES'", notApplicableWhen:"Q-INS-DAMAGE-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-15", title:"電気・ガス・水道の名義変更または解約をする", domain:"HOUSING", phase:"D14", priority:75, dependsOn:[], requiredQuestions:["Q-UTIL-01"], ruleType:"CONFIRMED", appliesWhen:"Q-UTIL-01=='YES'", notApplicableWhen:"Q-UTIL-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-16", title:"携帯電話・サブスクの解約または名義変更をする", domain:"DIGITAL", phase:"D14", priority:78, dependsOn:["RN-H24-11"], requiredQuestions:["Q-DIG-01"], ruleType:"CONFIRMED", appliesWhen:"Q-DIG-01.containsAny('MOBILE','SUBSCRIPTIONS','ACCOUNTS')", notApplicableWhen:"Q-DIG-01.includes('NONE')", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-17", title:"クレジットカードの届出・解約をする", domain:"FINANCE", phase:"D14", priority:77, dependsOn:[], requiredQuestions:["Q-FIN-01"], ruleType:"CONFIRMED", appliesWhen:"Q-FIN-01.containsAny('CARD')", notApplicableWhen:"Q-FIN-01.includes('NONE')", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-18", title:"賃貸住宅の名義変更・解約をする（町営住宅含む）", domain:"HOUSING", phase:"D14", priority:65, dependsOn:[], requiredQuestions:["Q-RENT-01"], ruleType:"CONFIRMED", appliesWhen:"Q-RENT-01=='YES'", notApplicableWhen:"Q-RENT-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-19", title:"NHK・固定電話の解約、郵便物の転送届を出す", domain:"HOUSING", phase:"D14", priority:55, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D14-20", title:"遺言書の有無を確認する", domain:"INHERITANCE", phase:"D14", priority:80, dependsOn:[], requiredQuestions:["Q-WILL-01"], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D14-22", title:"マイナンバーカード（通知カード）を返納する", domain:"ADMIN", phase:"D14", priority:50, dependsOn:["RN-D7-06"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D14-23", title:"故人の健康保険の被扶養者だった方は、保険の切替え手続きをする", domain:"HEALTH", phase:"D14", priority:88, dependsOn:["RN-D14-02"], requiredQuestions:["Q-HI-01","Q-DEPENDENT-01"], ruleType:"CONFIRMED", appliesWhen:"Q-HI-01=='EHI'&&Q-DEPENDENT-01=='YES'", notApplicableWhen:"Q-HI-01!='EHI'||Q-DEPENDENT-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D14-24", title:"児童扶養手当・ひとり親関連の給付を確認する", domain:"GOVT_BENEFIT", phase:"D14", priority:80, dependsOn:["RN-D7-06"], requiredQuestions:["Q-CHILD-U18-01","Q-REL-01"], ruleType:"CONFIRMED", appliesWhen:"Q-CHILD-U18-01=='YES'&&Q-REL-01=='SPOUSE'", notApplicableWhen:"Q-CHILD-U18-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-D49-01", title:"納骨先を決め、墓地管理者・寺院に連絡する", domain:"FUNERAL", phase:"D49", priority:60, dependsOn:["RN-D7-07"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-D49-02", title:"香典返し・会葬御礼の手配をする", domain:"FUNERAL", phase:"D49", priority:55, dependsOn:["RN-D7-02"], requiredQuestions:["Q-FUN-STATUS-01"], ruleType:"CONFIRMED", appliesWhen:"['NOT_DECIDED','ARRANGING','SCHEDULED','COMPLETED'].includes(Q-FUN-STATUS-01)", notApplicableWhen:"['DIRECT_CREMATION','NO_FUNERAL'].includes(Q-FUN-STATUS-01)", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-M3-01", title:"相続放棄・限定承認の要否を判断する【期限3か月】", domain:"INHERITANCE", phase:"M3", priority:90, dependsOn:["RN-D14-20"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-M3-02", title:"負債（借金・保証・連帯債務）を調査する", domain:"FINANCE", phase:"M3", priority:85, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-M3-03", title:"故人の戸籍（出生〜死亡）と相続人全員の戸籍・印鑑証明書を収集する", domain:"INHERITANCE", phase:"M3", priority:80, dependsOn:["RN-D7-06"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-M3-04", title:"住宅ローン・借入金の届出をする（団信の適用確認含む）", domain:"FINANCE", phase:"M3", priority:75, dependsOn:["RN-M3-02"], requiredQuestions:["Q-LOAN-01"], ruleType:"CONFIRMED", appliesWhen:"Q-LOAN-01=='YES'", notApplicableWhen:"Q-LOAN-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-M3-05", title:"法定相続情報一覧図を取得する（法務局）", domain:"INHERITANCE", phase:"M3", priority:70, dependsOn:["RN-M3-03"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-M3-07", title:"相続財産目録を作成する", domain:"INHERITANCE", phase:"M3", priority:90, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-M3-10", title:"相続手続きの代表者を決める（財産管理も担う）", domain:"INHERITANCE", phase:"M3", priority:60, dependsOn:[], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-M3-11", title:"遺産分割協議書を作成する（相続人全員の合意・署名・実印）", domain:"INHERITANCE", phase:"M3", priority:85, dependsOn:["RN-M3-07","RN-M3-03"], requiredQuestions:[], ruleType:"GENERAL", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"OPEN"},
            {id:"RN-M3-12", title:"農地の相続届出を行う（農業委員会への届出）【届出期限おおむね10か月】", domain:"INHERITANCE", phase:"M3", priority:70, dependsOn:["RN-D7-06"], requiredQuestions:["Q-AGRI-01"], ruleType:"CONFIRMED", appliesWhen:"Q-AGRI-01=='YES'", notApplicableWhen:"Q-AGRI-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-M4-01", title:"準確定申告を行う【申告期限4か月】", domain:"TAX", phase:"M4", priority:75, dependsOn:["RN-M3-07"], requiredQuestions:["Q-TAX-01"], ruleType:"POSSIBLE", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-M10-01", title:"相続税申告の要否を判定する", domain:"TAX", phase:"M10", priority:60, dependsOn:["RN-M3-07"], requiredQuestions:[], ruleType:"POSSIBLE", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-M10-05", title:"銀行口座の解約・払戻しを行う", domain:"FINANCE", phase:"M10", priority:75, dependsOn:["RN-M3-07","RN-M3-11"], requiredQuestions:["Q-FIN-01"], ruleType:"POSSIBLE", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-M10-07", title:"自動車の名義変更または廃車手続きをする", domain:"CAR", phase:"M10", priority:60, dependsOn:[], requiredQuestions:["Q-CAR-01"], ruleType:"POSSIBLE", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-M10-08", title:"故人の運転免許証を返納する", domain:"ADMIN", phase:"M10", priority:30, dependsOn:[], requiredQuestions:["Q-CAR-01"], ruleType:"CONFIRMED", appliesWhen:"Q-CAR-01=='YES'", notApplicableWhen:"Q-CAR-01=='NO'", fallbackStatus:"NEED_CONFIRM"},
            {id:"RN-Y3-01", title:"不動産の相続登記を申請する【期限3年】※固定資産評価証明書の取得含む", domain:"INHERITANCE", phase:"Y3", priority:65, dependsOn:["RN-M3-11"], requiredQuestions:["Q-RE-01"], ruleType:"POSSIBLE", appliesWhen:"true", notApplicableWhen:null, fallbackStatus:"NEED_CONFIRM"}
        ];

        const phases = {
            H24: "今日・葬儀まで",
            D7: "7日以内",
            D14: "14日以内",
            D49: "四十九日まで",
            M3: "3ヶ月以内",
            M4: "4か月以内",
            M10: "10ヶ月以内",
            Y3: "3年以内"
        };

        const domainLabels = {
            ADMIN: "行政", FUNERAL: "葬儀", FINANCE: "お金", INSURANCE: "保険",
            HEALTH: "健康保険", PENSION: "年金・保険", HOUSING: "住まい", DIGITAL: "デジタル",
            INHERITANCE: "相続", TAX: "税金", CAR: "自動車", EMPLOYMENT: "勤務", GOVT_BENEFIT: "給付金"
        };

        // 行き先順グループ定義
        const destinationGroups = [
            {
                id: "hokuryu_yakuba",
                name: "北竜町役場",
                icon: "●",
                description: "北海道雨竜郡北竜町字和11-1",
                phone: "0164-34-2111",
                hours: "平日 8:30-17:15",
                matchRule: (dest) => dest && (dest.includes("北竜町役場") || dest.includes("北竜町") || dest.includes("役場"))
            },
            {
                id: "nenkin",
                name: "年金事務所（深川）",
                icon: "●",
                description: "北海道深川市2条18番36号",
                phone: "0164-23-1299",
                hours: "平日 8:30-17:15",
                matchRule: (dest) => dest && (dest.includes("年金事務所") || dest.includes("深川年金"))
            },
            {
                id: "homukyoku",
                name: "法務局・家庭裁判所（深川）",
                icon: "●",
                description: "北海道深川市3条2番1号",
                phone: "0164-23-3269",
                hours: "平日 8:30-17:15",
                matchRule: (dest) => dest && (dest.includes("法務局") || dest.includes("家庭裁判所") || dest.includes("公証役場"))
            },
            {
                id: "zeimusho",
                name: "深川税務署",
                icon: "●",
                description: "北海道深川市2条17番17号",
                phone: "0164-23-2191",
                hours: "平日 8:30-17:00",
                matchRule: (dest) => dest && (dest.includes("税務署") || dest.includes("深川税務署"))
            },
            {
                id: "sougisha",
                name: "葬儀社",
                icon: "●",
                description: "",
                phone: "",
                hours: "",
                matchRule: (dest, domain) => domain === "FUNERAL" || (dest && dest.includes("葬儀"))
            },
            {
                id: "bank",
                name: "銀行・証券会社",
                icon: "●",
                description: "口座のある各金融機関",
                phone: "",
                hours: "平日 9:00-15:00（窓口）",
                matchRule: (dest) => dest && (dest.includes("銀行") || dest.includes("証券"))
            },
            {
                id: "hoken",
                name: "保険会社・共済",
                icon: "●",
                description: "加入先の各保険会社",
                phone: "",
                hours: "",
                matchRule: (dest) => dest && (dest.includes("保険会社") || dest.includes("共済") || dest.includes("協会けんぽ"))
            },
            {
                id: "kinmusaki",
                name: "勤務先（自分 / 故人）",
                icon: "●",
                description: "",
                phone: "",
                hours: "",
                matchRule: (dest, domain) => domain === "EMPLOYMENT" || (dest && dest.includes("勤務先"))
            },
            {
                id: "keisatsu",
                name: "警察署（深川）",
                icon: "●",
                description: "北海道深川市4条8番20号",
                phone: "0164-22-0110",
                hours: "平日 8:30-17:15",
                matchRule: (dest) => dest && dest.includes("警察")
            },
            {
                id: "unyu",
                name: "運輸支局（旭川）",
                icon: "●",
                description: "北海道旭川市春光町10番地",
                phone: "050-5540-2003",
                hours: "平日 8:45-16:00",
                matchRule: (dest) => dest && (dest.includes("運輸支局") || dest.includes("軽自動車検査"))
            },
            {
                id: "telecom",
                name: "携帯キャリア・通信・NHK",
                icon: "●",
                description: "",
                phone: "",
                hours: "",
                matchRule: (dest) => dest && (dest.includes("キャリア") || dest.includes("NHK") || dest.includes("NTT") || dest.includes("カスタマーセンター") || dest.includes("カード会社"))
            },
            {
                id: "jitaku",
                name: "自宅・その他",
                icon: "●",
                description: "自宅での確認・準備作業",
                phone: "",
                hours: "",
                matchRule: () => true  // 上記いずれにも該当しないタスクはここに入る
            }
        ];

        // 明示的グループマッピング
        const explicitGroupMap = {
            "RN-D14-02": "hokuryu_yakuba",
            "RN-D14-03": "hokuryu_yakuba",
            "RN-D14-04": "hokuryu_yakuba",
            "RN-D14-06": "nenkin",
            "RN-D14-07": "nenkin",
            "RN-D14-08": "nenkin",
            "RN-D14-23": "hokuryu_yakuba",
            "RN-D14-24": "hokuryu_yakuba",
            "RN-D14-19": "telecom",
            "RN-D14-20": "jitaku",
            "RN-H24-01": "jitaku",
            "RN-H24-02": "jitaku",
            "RN-H24-04": "jitaku",
            "RN-H24-05": "jitaku",
            "RN-H24-06": "jitaku",
            "RN-H24-11": "jitaku",
            "RN-D7-10": "jitaku",
            "RN-M3-02": "jitaku",
            "RN-M3-07": "jitaku",
            "RN-M3-10": "jitaku",
            "RN-M3-11": "jitaku",
            "RN-D14-15": "telecom",
            "RN-D14-16": "telecom",
            "RN-D14-17": "telecom",
            "RN-D14-18": "hokuryu_yakuba",
            "RN-D14-11": "hoken",
            "RN-D14-12": "hoken",
            "RN-D14-09": "bank",
            "RN-D14-10": "bank",
            "RN-M10-05": "bank",
            "RN-M3-04": "bank"
        };

        // タスクの行き先グループを判定
        function getTaskDestinationGroup(task) {
            // 明示的マッピングをチェック
            if (explicitGroupMap[task.id]) {
                return explicitGroupMap[task.id];
            }

            // taskDetailsからdestinationを取得
            const detail = taskDetails[task.id];
            const dest = detail ? detail.destination : '';
            const domain = task.domain;

            // グループを順番に走査
            for (let group of destinationGroups) {
                if (group.matchRule(dest, domain)) {
                    return group.id;
                }
            }

            // デフォルト（ここには到達しないはず）
            return "jitaku";
        }

        // タスク詳細データ
        const taskDetails = {
  "RN-H24-01": {
    actionSummary: "病院・主治医から「死亡診断書（死体検案書）」を受け取る",
    whyNeeded: "死亡届の提出、保険金請求、年金手続き等すべての起点となる最重要書類です。これがないと何も始められません。",
    destination: "故人が亡くなった病院・施設",
    requiredDocs: "なし（医師が作成・交付）",
    steps: "①医師からの連絡を待つ/②死亡診断書を受け取る/③記載内容を確認（氏名・死亡日時・死因に誤りがないか）/④原本をクリアファイルに保管",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "死亡診断書の原本が手元にあり、記載内容を確認済み。",
    faq: "Q.費用は？→3,000〜10,000円程度。検案書は30,000〜100,000円の場合も/Q.何部もらえる？→原本は通常1部。コピーで対応/Q.名前の漢字が違う→その場で医師に伝えて修正"
  },
  "RN-H24-02": {
    actionSummary: "死亡診断書の原本をコピーし、5部以上を保管する",
    whyNeeded: "死亡届提出時に原本は役場に回収されます。保険金請求、銀行届出等でコピーが必要になるため、提出前に必ずコピーしてください。",
    destination: "コンビニ、役場コピー機、自宅プリンター等",
    requiredDocs: "死亡診断書（原本）",
    steps: "①原本を用意/②5部以上コピー（10部推奨）/③鮮明さを確認/④原本とコピーを別々に保管",
    officeHours: "コンビニなら24時間",
    address: "",
    phone: "",
    doneCondition: "コピーが5部以上あり、原本と分けて保管されている。",
    faq: "Q.何部あれば？→最低5部、10部あると安心/Q.スマホ撮影でもいい？→撮影も便利だが正式には紙コピーが必要"
  },
  "RN-H24-03": {
    actionSummary: "病院等からご遺体を搬送する手配をし、安置先を決める",
    whyNeeded: "病院の霊安室は長時間の安置ができません。葬儀社が決まっていなくても、搬送だけを依頼できます。",
    destination: "葬儀社／自宅／安置施設",
    requiredDocs: "死亡診断書（搬送時携行）",
    steps: "①葬儀社が決まっている→連絡して搬送依頼/②決まっていない→病院提携の搬送業者に依頼/③安置先を決める（自宅or安置施設）/④搬送時に死亡診断書を携行",
    officeHours: "24時間対応",
    address: "",
    phone: "",
    doneCondition: "ご遺体が安置先に搬送・安置されている。",
    faq: "Q.葬儀社未定だが搬送できる？→搬送だけ先に依頼可。その葬儀社に葬儀を頼む義務なし/Q.自宅安置は可能？→可能。ドライアイス手配が必要/Q.費用は？→搬送のみ10,000〜30,000円程度"
  },
  "RN-H24-04": {
    actionSummary: "故人の通帳・印鑑・証券・保険証券・年金手帳等の貴重品を確保し、安全な場所に保管する",
    whyNeeded: "今後の手続き（銀行届出・保険金請求・相続）すべてで必要。紛失すると再発行に時間がかかり手続き全体が遅れます。",
    destination: "故人の自宅・施設の居室",
    requiredDocs: "なし",
    steps: "①自宅で通帳・カード・印鑑・保険証券・年金手帳等を探す/②リスト化（メモまたは撮影）/③1か所にまとめて保管/④保管場所を家族で共有",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "貴重品リストが作成され、安全な場所に保管されている。",
    faq: "Q.通帳が見つからない→銀行届出で再発行可/Q.印鑑が不明→全部保管して銀行で照合/Q.同居でなく自宅に入れない→大家等に事情説明し立ち会い入室"
  },
  "RN-H24-05": {
    actionSummary: "故人の自宅の施錠・火の元・水回りを確認する",
    whyNeeded: "空き家状態での防犯リスク、北竜町冬季の水道管凍結・ガス漏れ等の事故防止のために早めの確認が必要です。",
    destination: "故人の自宅",
    requiredDocs: "なし",
    steps: "①全窓・ドアの施錠確認/②ガス元栓を閉める/③水回り確認/④冬季は水抜き/⑤不要な電気機器のコンセントを抜く（スマホ充電は維持）/⑥冷蔵庫内確認/⑦郵便受けに鍵",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "施錠・火の元・水回りが確認され安全な状態。",
    faq: "Q.同居の場合→故人の部屋の窓施錠を確認/Q.遠方で行けない→近くの親族や大家に依頼/Q.冬場の水抜き不明→北竜町役場(0164-34-2111)に相談"
  },
  "RN-H24-06": {
    actionSummary: "葬儀の喪主を家族間で決める",
    whyNeeded: "葬儀社との打ち合わせ、弔電の宛名、費用負担の窓口など葬儀全体の代表者が必要です。",
    destination: "",
    requiredDocs: "なし",
    steps: "①家族で話し合い喪主を決める/②優先順位：配偶者→長男→長女→最も近い親族/③喪主と施主は別でも可/④葬儀社に喪主の氏名・連絡先を伝える",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "喪主が決まり、家族間で共有されている。",
    faq: "Q.誰がやるべき？→法律上の決まりなし。配偶者が多い/Q.喪主と施主の違い→喪主は代表者、施主は費用負担者/Q.一人っ子で配偶者なし→甥姪や友人も可"
  },
  "RN-H24-11": {
    actionSummary: "故人のスマホ・PC・タブレットの電源を維持し、データを保全する",
    whyNeeded: "スマホにはサブスク契約、SNS、二段階認証、電子決済の情報が入っています。電池切れで解約・引継ぎが極めて困難になります。",
    destination: "",
    requiredDocs: "なし",
    steps: "①故人のスマホ・PC等を探す/②充電器に接続し電源維持/③絶対にリセットしない/④パスコードの心当たりをメモ/⑤SIMカードは抜かない/⑥自動ロック時間の延長を検討",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "デジタル機器が充電され、電源が維持されている。",
    faq: "Q.パスコード不明→電源維持してキャリアショップ等に相談/Q.指紋・顔認証使えない→死後は生体認証不可。PIN必要/Q.スマホ見つからない→通信キャリアにGPS確認を相談"
  },
  "RN-D7-01": {
    actionSummary: "葬儀を依頼する葬儀社を選定し、連絡する",
    whyNeeded: "葬儀の段取りはすべて葬儀社との打ち合わせで決まります。搬送を依頼した葬儀社に頼む義務はありません。",
    destination: "葬儀社",
    requiredDocs: "なし",
    steps: "①互助会加入→加入先に連絡/②未加入→2〜3社に概算見積/③見積内容を比較/④1社に決めて正式依頼",
    officeHours: "24時間対応（多くの葬儀社）",
    address: "",
    phone: "",
    doneCondition: "葬儀社が決まり、正式に依頼済み。",
    faq: "Q.互助会に入っていたか不明→通帳で毎月の引落し確認/Q.搬送を頼んだ葬儀社に決めなきゃ？→別の社に依頼OK/Q.費用相場→一般葬100〜200万、家族葬30〜80万"
  },
  "RN-D7-02": {
    actionSummary: "葬儀社と打ち合わせし、日程・式場・形式・予算を決定する",
    whyNeeded: "日程が決まらないと関係者連絡、お寺への依頼、火葬場予約が進みません。",
    destination: "葬儀社事務所または自宅",
    requiredDocs: "なし（死亡診断書コピーがあるとスムーズ）",
    steps: "①打ち合わせ日時を決める/②形式を決める（一般葬/家族葬/一日葬/直葬）/③予算上限を伝える/④式場・日程を決める/⑤見積書をもらい内訳確認/⑥返礼品・飲食の相談",
    officeHours: "葬儀社の営業時間",
    address: "",
    phone: "",
    doneCondition: "日程・式場・形式・予算が確定し、見積書を受領済み。",
    faq: "Q.家族葬と一般葬の違い→家族葬は近親者のみ/Q.友引は避ける？→北海道では気にしない方も。火葬場の休みを確認/Q.見積に含まれないもの→お布施、心付け、飲食追加分"
  },
  "RN-D7-04": {
    actionSummary: "故人の関係者へ訃報（死亡の知らせ・葬儀の案内）を連絡する",
    whyNeeded: "参列希望者への案内、弔電・供花の受付のために必要。家族葬の場合は参列辞退のお伝えも大切です。",
    destination: "",
    requiredDocs: "なし",
    steps: "①連絡先リスト作成（親族→勤務先→友人→町内会）/②伝える内容を整理/③家族葬の場合は「家族のみ」と明確に/④電話→メール/LINEの順/⑤北竜町の場合、町内会長・隣組への連絡も検討",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "主要関係者への訃報連絡が完了。",
    faq: "Q.家族葬なのに参列したいと言われたら→「故人の遺志により家族のみ」と丁重に/Q.SNSで知らせてよい？→家族合意があれば可。拡散範囲に注意/Q.勤務先にはいつ→できるだけ早く"
  },
  "RN-D7-05": {
    actionSummary: "葬儀で使用する遺影用の写真を選び、葬儀社に渡す",
    whyNeeded: "遺影は祭壇に飾る故人のお写真。葬儀社が引き伸ばし・加工しますが、元の写真が必要です。",
    destination: "葬儀社",
    requiredDocs: "故人の写真（プリント/スマホデータ）",
    steps: "①スマホ・アルバム・PCから写真を探す/②ピントが合い正面向きの写真を選ぶ/③最近の写真が望ましい/④2〜3枚選んで葬儀社に渡す/⑤背景・服装の加工は葬儀社が対応",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "遺影用写真を葬儀社に渡し済み。",
    faq: "Q.いい写真がない→集合写真の切抜きやスマホ写真でもOK/Q.帽子やサングラス→外した方が望ましいが故人らしさ優先の方も/Q.費用→葬儀プランに含まれることが多い"
  },
  "RN-D7-06": {
    actionSummary: "北竜町役場 1F 住民課へ「死亡届」を提出する",
    whyNeeded: "ご遺体の火葬を行うための「火葬許可証」が必要です。死亡届を提出しないと火葬許可証が発行されません。",
    destination: "北竜町役場",
    requiredDocs: "死亡診断書（原本）、届出人の印鑑",
    steps: "①死亡診断書と届出人の印鑑を用意/②北竜町役場 1F 住民課へ行く/③窓口で「死亡届の提出」と伝える/④死亡届に必要事項を記入して提出/⑤「火葬許可証」を受け取り保管",
    officeHours: "平日 8:30-17:15（時間外・休日は当直窓口で届出のみ可能）",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "死亡届が受理され、火葬許可証が手元にあり保管されている。",
    faq: "Q.窓口で何て言えば？→「死亡届の提出」と伝える/Q.届出は誰が？→同居親族、親族、家主等。葬儀社代行も多い/Q.期限過ぎたら→受理されるが過料の対象になりうる"
  },
  "RN-D7-07": {
    actionSummary: "火葬後に交付される「埋葬許可証」を受け取り、安全に保管する",
    whyNeeded: "納骨の際に墓地管理者・寺院に提出が必要。紛失すると再発行に手間がかかります。",
    destination: "火葬場（火葬後に交付）",
    requiredDocs: "火葬許可証（提出済みのもの）",
    steps: "①火葬終了後、火葬場窓口で受け取る/②記載内容を確認/③骨壺と一緒にまたはクリアファイルで保管/④保管場所を家族で共有",
    officeHours: "火葬場の営業時間内",
    address: "",
    phone: "",
    doneCondition: "埋葬許可証が手元にあり、保管場所が共有されている。",
    faq: "Q.埋葬許可証と火葬許可証は同じ？→火葬許可証に「火葬済」印が押されたもの/Q.紛失したら→火葬した市区町村で再発行可/Q.納骨はいつまで→法律上の期限なし"
  },
  "RN-D7-10": {
    actionSummary: "故人の銀行口座からの自動引落し（公共料金・ローン・保険料等）を確認しリスト化する",
    whyNeeded: "銀行に死亡届出後に口座凍結されると自動引落しが停止。公共料金やローン等の滞納を防ぐため事前に把握が必要。",
    destination: "",
    requiredDocs: "故人の通帳・カード、銀行からの郵便物",
    steps: "①通帳の直近3〜6ヶ月を確認/②定期的引落しをリスト化/③各引落し先の連絡先をメモ/④名義変更・解約が必要なものを整理/⑤銀行届出のタイミングを決める",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "自動引落しリストが作成され、対応方針が整理されている。",
    faq: "Q.通帳が未記帳→ATMで記帳するか銀行窓口で明細取得（凍結前に）/Q.ネット銀行で通帳なし→スマホ/PCからログインし取引履歴確認/Q.口座凍結のタイミング→銀行に届け出た時点で凍結"
  },
  "RN-D7-11": {
    actionSummary: "北竜町役場で一度の来庁でまとめて行える手続きを事前に確認し、準備する",
    whyNeeded: "何度も役場に足を運ばなくて済むよう、まとめてできる手続きを1回の来庁で処理しましょう。",
    destination: "北竜町役場",
    requiredDocs: "死亡診断書コピー、本人確認書類、印鑑、故人の保険証・年金手帳等",
    steps: "①タスクリストで役場対応の手続きをピックアップ/②必要書類を事前準備/③役場に電話して持参物を確認/④来庁して一括手続き",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "まとめ手続きと必要書類リストが整理され、来庁段取りが決定。",
    faq: "Q.おくやみ窓口はある？→専用窓口がなくても住民課に事前連絡で各課案内/Q.代理人OK？→委任状があれば多くは可能/Q.1日で終わる？→2〜3時間で主要なものは完了が多い"
  },
  "RN-D7-12": {
    actionSummary: "自分の勤務先に親族の死亡を届け出て、忌引休暇・弔慰金・団体保険等を確認する",
    whyNeeded: "忌引休暇の取得、弔慰金・見舞金の受給、団体生命保険の確認など勤務先からの支援を受けるために必要。",
    destination: "自分の勤務先の総務部・人事部",
    requiredDocs: "死亡診断書コピー（会社による）、会葬礼状",
    steps: "①直属の上司に連絡/②誰が亡くなったか・続柄・葬儀日程を伝える/③忌引休暇の日数・手続きを確認/④弔慰金・見舞金の有無を確認/⑤団体保険の加入確認/⑥福利厚生サービス（EAP等）の利用可否確認",
    officeHours: "勤務先の営業時間",
    address: "",
    phone: "",
    doneCondition: "勤務先への届出完了、忌引・弔慰金・団体保険の状況確認済み。",
    faq: "Q.忌引休暇は何日？→就業規則による。配偶者5〜10日、親5〜7日、兄弟3日が目安/Q.弔慰金はいくら？→5,000〜100,000円が一般的/Q.団体保険の確認方法→給与明細の控除欄"
  },
  "RN-D7-13": {
    actionSummary: "北竜町役場で故人の住民票の除票を取得する",
    whyNeeded: "銀行届出、保険金請求、相続手続き等で故人の最後の住所を証明するために必要。複数枚まとめて取得推奨。",
    destination: "北竜町役場 1F 住民課",
    requiredDocs: "本人確認書類、印鑑、故人との関係が分かる書類",
    steps: "①住民課の窓口へ行く/②「住民票の除票を取得したい」と伝える/③請求書に記入/④本人確認書類を提示/⑤手数料支払い（1通300円程度）/⑥3〜5通取得推奨",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "住民票の除票を必要部数取得済み。",
    faq: "Q.何通必要？→3〜5通推奨/Q.死亡届後すぐ取得可？→処理後1〜2営業日後から/Q.遠方の場合→郵送請求可能"
  },
  "RN-D7-14": {
    actionSummary: "故人の勤務先に死亡を届け出て、退職手続き・死亡退職金・貸与品返却等を進める",
    whyNeeded: "給与・退職金精算、社保喪失手続き、貸与品返却が必要。勤務先も業務引継ぎの手配があります。",
    destination: "故人の勤務先の総務部・人事部",
    requiredDocs: "死亡診断書コピー、届出者の本人確認書類",
    steps: "①勤務先の総務に電話/②故人氏名・死亡日・届出者の続柄を伝える/③確認事項：最終給与精算、退職金、社保喪失、貸与品返却、有給消化/④私物引取り段取り/⑤源泉徴収票発行を依頼",
    officeHours: "勤務先の営業時間",
    address: "",
    phone: "",
    doneCondition: "故人勤務先への届出完了、退職手続き・退職金・貸与品返却の段取り確認済み。",
    faq: "Q.連絡しづらい→「○○の遺族ですが、総務のご担当者様を」と伝えればOK/Q.退職金はいくら→会社規程による。総務に確認/Q.社会保険証は返す？→はい。勤務先経由で返却"
  },
  "RN-D14-01": {
    actionSummary: "北竜町役場 1F 住民課で「世帯主変更届」を提出する",
    whyNeeded: "故人が世帯主の場合、14日以内に届出が必要。届出が遅れると住民票や保険証の記載に影響します。",
    destination: "北竜町役場 1F 住民課",
    requiredDocs: "本人確認書類、印鑑、国保保険証（あれば持参）",
    steps: "①新世帯主を家族で決める/②住民課窓口へ行く/③「世帯主変更届」と伝える/④住民異動届に記入・提出/⑤国保加入者は保険証の世帯主変更も同時に",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "世帯主変更届が受理され、住民票に反映されている。",
    faq: "Q.残り1人なら届出不要？→自動的に世帯主になるため不要/Q.配偶者と15歳未満の子だけ→原則届出不要/Q.期限過ぎたら→5万円以下の過料の可能性"
  },
  "RN-D14-02": {
    actionSummary: "故人の健康保険の資格喪失届を提出し、保険証を返却する",
    whyNeeded: "故人の保険証で医療費が請求されると後から返還を求められます。速やかに届出を。",
    destination: "国保：北竜町役場 / 社保：故人の勤務先 / 後期高齢者：北竜町役場",
    requiredDocs: "故人の保険証、死亡確認書類、届出人の本人確認書類、印鑑",
    steps: "①保険証の種類を確認（国保/社保/後期高齢者）/②国保→役場で返却・届出/③社保→勤務先の総務に連絡/④後期高齢者→役場に返却/⑤高額療養費の未申請分を確認",
    officeHours: "平日 8:30-17:15（役場）",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "資格喪失届が提出され、保険証が返却済み。",
    faq: "Q.保険証が見つからない→紛失旨を届出書に記載でOK/Q.社保は自分で手続き？→勤務先が手続き。保険証を返却/Q.国保と後期高齢者の違い→75歳以上は後期高齢者"
  },
  "RN-D14-03": {
    actionSummary: "故人の健康保険から葬祭費（国保）または埋葬料（社保）を申請し、約5万円を受け取る",
    whyNeeded: "葬儀を行った方に給付金が支給されます。申請しないともらえません。",
    destination: "国保・後期高齢者：北竜町役場 / 社保：協会けんぽ支部等",
    requiredDocs: "故人の保険証、葬儀の領収書/会葬礼状、申請者の振込先口座、印鑑",
    steps: "①保険種別を確認/②国保・後期高齢者→役場で「葬祭費の申請」と伝え申請書記入/③社保→「埋葬料支給申請書」を協会けんぽに郵送/④振込先口座を記入/⑤支給（1〜2ヶ月後）",
    officeHours: "平日 8:30-17:15（役場）",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "葬祭費（埋葬料）の申請書を提出済み。",
    faq: "Q.いくらもらえる？→国保：自治体による（3〜7万）。社保：一律5万/Q.領収書がまだない→会葬礼状でも可。後日申請OK（時効2年）/Q.直葬でも？→はい。火葬費用の負担者が申請可"
  },
  "RN-D14-04": {
    actionSummary: "故人の医療費が高額療養費の限度額を超えていないか確認し、超えていれば還付申請する",
    whyNeeded: "入院や長期治療で医療費が高額になった場合、自己負担限度額超過分が戻ります。知らないと損をします。",
    destination: "国保・後期高齢者：北竜町役場 / 社保：協会けんぽ支部等",
    requiredDocs: "故人の保険証、医療費の領収書、振込先口座、印鑑",
    steps: "①医療費領収書を集める/②月ごとの自己負担額を確認/③限度額超過→還付申請/④国保→役場で「高額療養費の申請」/⑤社保→協会けんぽに申請書郵送",
    officeHours: "平日 8:30-17:15（役場）",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "高額療養費の該当有無を確認済み。該当時は申請提出済み。",
    faq: "Q.限度額はいくら？→年齢・所得により異なる。70歳未満一般で約8万/月/Q.入院してなくても？→通院でも限度額超過なら対象/Q.確認方法不明→役場に電話して確認依頼"
  },
  "RN-D14-05": {
    actionSummary: "故人の介護保険被保険者証を返却し、保険料精算・高額介護サービス費の還付を確認する",
    whyNeeded: "介護保険料の過不足精算、高額介護サービス費の還付がある場合があります。被保険者証の返却も必要。",
    destination: "北竜町役場",
    requiredDocs: "介護保険被保険者証、負担割合証、届出人の本人確認書類、印鑑",
    steps: "①被保険者証を持参/②役場窓口で「介護保険の届出」と伝える/③被保険者証を返却/④保険料の精算確認/⑤高額介護サービス費の還付確認/⑥施設利用時は施設にも連絡・精算",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "被保険者証を返却し、保険料精算・還付の確認完了。",
    faq: "Q.65歳未満は対象？→40〜64歳で要介護認定者は対象/Q.施設費用が未精算→施設に直接連絡/Q.保険料還付はある？→月途中死亡は過払い分が還付される場合あり"
  },
  "RN-D14-06": {
    actionSummary: "年金事務所に「受給権者死亡届」を提出し、故人の年金受給を停止する",
    whyNeeded: "届出遅延で死亡後も年金が振り込まれると返還を求められ、手続きが非常に煩雑になります。",
    destination: "深川年金事務所 / 国民年金のみは北竜町役場でも可",
    requiredDocs: "故人の年金証書、死亡確認書類、届出人の本人確認書類",
    steps: "①年金証書を用意/②「受給権者死亡届」を記入/③年金事務所に提出（郵送可）/④国民年金のみ→北竜町役場でも届出可/⑤厚生年金→年金事務所に提出（10日以内）/⑥未支給年金の請求も同時検討",
    officeHours: "平日 8:30-17:15",
    address: "深川年金事務所：北海道深川市2条18番36号",
    phone: "0164-23-1299",
    doneCondition: "受給権者死亡届が提出され、年金受給が停止処理されている。",
    faq: "Q.年金証書が見つからない→基礎年金番号があれば手続き可/Q.マイナンバー登録済なら届出不要？→省略できる場合あり。事務所に確認/Q.死亡後に振り込まれた年金→返還が必要。未支給年金と相殺可"
  },
  "RN-D14-07": {
    actionSummary: "故人が受け取れなかった年金（未支給年金）を請求する",
    whyNeeded: "年金は後払いのため死亡月までの未受給分が発生。生計同一の遺族が請求可。請求しないと受け取れません。",
    destination: "深川年金事務所 / 国民年金は北竜町役場",
    requiredDocs: "故人の年金証書、戸籍謄本、生計同一証明書類、振込先口座、印鑑",
    steps: "①「未支給年金・保険給付請求書」を記入/②受給停止届と同時提出が効率的/③必要書類を添付/④年金事務所に提出（郵送可）/⑤支給（審査後2〜3ヶ月で振込）",
    officeHours: "平日 8:30-17:15",
    address: "深川年金事務所：北海道深川市2条18番36号",
    phone: "0164-23-1299",
    doneCondition: "未支給年金の請求書が提出済み。",
    faq: "Q.誰が請求できる？→生計同一の遺族（配偶者→子→父母…）/Q.別居でも？→経済的援助があれば認められうる。第三者証明必要/Q.いくら？→最大2ヶ月分"
  },
  "RN-D14-08": {
    actionSummary: "遺族基礎年金・遺族厚生年金の受給資格を確認し、該当時は請求手続きを進める",
    whyNeeded: "遺族年金は年額80〜200万円以上になることもあり、生活を支える重要な制度です。",
    destination: "深川年金事務所",
    requiredDocs: "故人の年金証書、戸籍謄本、住民票、収入証明、振込先口座、死亡診断書コピー",
    steps: "①受給資格を確認/②遺族基礎年金：18歳年度末までの子がいる配偶者/子/③遺族厚生年金：厚生年金加入歴あり、配偶者等が該当/④年金事務所に電話or来所で確認/⑤該当時は書類揃えて請求",
    officeHours: "平日 8:30-17:15",
    address: "深川年金事務所：北海道深川市2条18番36号",
    phone: "0164-23-1299",
    doneCondition: "受給資格の有無が確認済み。該当時は請求に着手済み。",
    faq: "Q.共働きでも？→年収850万未満なら受給可/Q.子なしでも？→遺族厚生年金は子なしでも配偶者が受給可の場合あり/Q.いくら？→加入期間・報酬による。年金事務所で試算可"
  },
  "RN-D14-09": {
    actionSummary: "故人名義の銀行口座について各銀行に死亡を届け出る",
    whyNeeded: "口座凍結で不正引出しを防止。相続手続きの起点にもなります。凍結前に自動引落し整理を。",
    destination: "各銀行の窓口",
    requiredDocs: "届出者の本人確認書類、故人の通帳・カード、死亡確認書類",
    steps: "①先に自動引落しの整理を完了/②口座がある銀行をリストアップ/③各銀行に電話し手続方法確認/④窓口で届出/⑤相続手続きの案内を受ける/⑥必要書類リストをもらう",
    officeHours: "平日 9:00-15:00（窓口）",
    address: "",
    phone: "",
    doneCondition: "全銀行口座について死亡届出が完了し、凍結されている。",
    faq: "Q.凍結で生活費が引き出せない？→相続預金の払戻し制度で1口座150万上限で引出可/Q.全部同時に届出？→同時でなくてよいが不正引出し防止のため早めに/Q.ネット銀行→カスタマーセンターに電話"
  },
  "RN-D14-10": {
    actionSummary: "故人名義の証券口座について証券会社に死亡を届け出る",
    whyNeeded: "口座凍結で株価変動による損失や不正売却を防止。相続手続き完了まで売買不可。",
    destination: "各証券会社の窓口/カスタマーセンター",
    requiredDocs: "届出者の本人確認書類、故人の口座番号が分かる書類、死亡確認書類",
    steps: "①証券口座がある会社をリストアップ/②各社カスタマーセンターに電話/③必要書類を提出/④相続手続きの案内・書類リスト受領/⑤相続人名義の口座開設案内も確認",
    officeHours: "各社による",
    address: "",
    phone: "",
    doneCondition: "全証券口座について死亡届出が完了。",
    faq: "Q.どの証券会社か不明→通帳の入金記録、郵便物、確定申告書から確認。証券保管振替機構に照会も可/Q.株価下落で早く売りたい→相続手続き完了まで不可。速やかに手続きを"
  },
  "RN-D14-11": {
    actionSummary: "故人が加入していた生命保険・医療保険・共済の死亡保険金を請求する",
    whyNeeded: "保険金は請求しないと支払われません。葬儀費用や生活費に充てられるため早めの請求推奨。",
    destination: "各保険会社のカスタマーセンター / 共済窓口",
    requiredDocs: "保険証券、死亡診断書コピー、受取人の本人確認書類・戸籍謄本・振込先口座・印鑑",
    steps: "①保険証券を確認/②各社に電話し「死亡保険金の請求」と伝える/③請求書類一式を取り寄せ/④書類を揃えて記入・提出/⑤支給（5営業日〜1ヶ月で振込）",
    officeHours: "各社による（多くは平日9:00-17:00）",
    address: "",
    phone: "",
    doneCondition: "全保険・共済の死亡保険金請求書を提出済み。",
    faq: "Q.保険証券見つからない→生命保険協会の「契約照会制度」で調査可/Q.受取人が故人→法定相続人が受取人に/Q.相続財産になる？→受取人指定ありは固有財産。ただし相続税対象"
  },
  "RN-D14-12": {
    actionSummary: "故人名義の損害保険について保険会社に届出し、名義変更または解約する",
    whyNeeded: "名義変更しないと事故時に保険金が支払われない可能性。特に自動車保険は早急対応が必要。",
    destination: "各損害保険会社のカスタマーセンター/代理店",
    requiredDocs: "保険証券、死亡確認書類、新名義人の本人確認書類",
    steps: "①故人名義の損害保険を確認/②各社/代理店に電話して死亡届出/③自動車保険→継続使用なら名義変更、不使用なら解約/④火災保険→住み続けるなら名義変更/⑤等級引継ぎの可否を確認",
    officeHours: "各社による",
    address: "",
    phone: "",
    doneCondition: "全損害保険の名義変更/解約が完了。",
    faq: "Q.等級引継ぎ→同居親族なら可能な場合が多い/Q.火災保険は急ぐ？→保険の空白期間を作らないよう早めに"
  },
  "RN-D14-15": {
    actionSummary: "故人名義の電気・ガス・水道の名義変更または解約をする",
    whyNeeded: "故人名義のままだと請求書が届かなくなったり、供給停止のリスクがあります。",
    destination: "電力会社・ガス会社・北竜町水道担当",
    requiredDocs: "故人名義の請求書/契約書、新名義人の本人確認書類",
    steps: "①故人名義の公共料金を確認/②住み続ける→各事業者に電話し名義変更/③空き家にする→解約（冬季の水道は要相談）/④北竜町水道→役場に連絡",
    officeHours: "各事業者による",
    address: "",
    phone: "北竜町役場（水道）：0164-34-2111",
    doneCondition: "全公共料金の名義変更/解約が完了。",
    faq: "Q.電話1本で？→名義変更は電話のみで完了が多い/Q.冬に水道解約→凍結リスクあり。必ず水抜き処理を。役場に相談"
  },
  "RN-D14-16": {
    actionSummary: "故人名義の携帯電話・サブスク・各種アカウントの解約/名義変更をする",
    whyNeeded: "放置すると毎月料金が発生。携帯番号はSMS二段階認証に使われていることが多く、解約前に他サービスの引継ぎ確認を。",
    destination: "各キャリアショップ・サービスのカスタマーセンター",
    requiredDocs: "故人の携帯・SIMカード、届出人の本人確認書類、死亡確認書類、故人との関係が分かる書類",
    steps: "①先にスマホのデータ確認（二段階認証の有無）/②サブスクをリスト化（通帳・カード明細・アプリ等から）/③携帯電話→キャリアショップで解約/④サブスク→各サービスに連絡解約/⑤SNS→追悼アカウントまたは削除",
    officeHours: "キャリアショップ：10:00〜19:00が一般的",
    address: "",
    phone: "",
    doneCondition: "全携帯電話・サブスクの解約/名義変更が完了。",
    faq: "Q.暗証番号不明で解約不可？→戸籍謄本と死亡証明があれば解約可能なキャリアがほとんど/Q.LINEのデータ残したい→解約前にバックアップを/Q.違約金は→死亡による解約は免除が多い"
  },
  "RN-D14-17": {
    actionSummary: "故人名義のクレジットカードについてカード会社に届出・解約する",
    whyNeeded: "放置すると年会費発生・不正利用リスク。カード決済のサブスクが停止しないまま残ることも。",
    destination: "各カード会社のカスタマーセンター",
    requiredDocs: "クレジットカード/会員番号、届出人の本人確認書類、死亡確認書類",
    steps: "①故人名義のカードをリストアップ/②各社に電話し「名義人死亡による解約」/③未払い残高の精算方法確認/④カード決済のサブスク・定期支払い確認/⑤ETCカード・家族カードの取扱い確認/⑥カード本体を裁断",
    officeHours: "各社による（24時間対応あり）",
    address: "",
    phone: "",
    doneCondition: "全カードの解約完了、未払い残高の精算方法確認済み。",
    faq: "Q.暗証番号不明→解約には不要。会員番号と死亡証明でOK/Q.リボ残高あり→相続人が支払い義務。一括か分割か相談/Q.ポイントは→多くは失効。カード会社に確認"
  },
  "RN-D14-18": {
    actionSummary: "故人名義の賃貸住宅（町営住宅含む）の名義変更/解約をする",
    whyNeeded: "住み続けるなら名義変更、退去なら解約が必要。町営住宅は独自規定があるため早めに役場に相談。",
    destination: "民間：管理会社・大家 / 町営住宅：北竜町役場",
    requiredDocs: "賃貸借契約書、届出人の本人確認書類、死亡確認書類",
    steps: "①賃貸契約を確認/②町営住宅→役場に連絡し承継/退去相談/③民間→管理会社/大家に連絡/④住み続ける→名義変更/⑤退去→解約・原状回復・敷金精算の段取り/⑥遺品整理日程の調整",
    officeHours: "役場：平日 8:30-17:15 / 管理会社：営業時間内",
    address: "北海道雨竜郡北竜町字和11-1（町営住宅）",
    phone: "0164-34-2111（役場）",
    doneCondition: "賃貸住宅の名義変更/解約の手続きが完了（開始済み）。",
    faq: "Q.町営住宅に住み続けたい→同居家族なら承継可能な場合あり/Q.退去タイミング→解約予告期間（通常1ヶ月前）が必要/Q.遺品整理業者→北竜町近隣の業者に見積もり"
  },
  "RN-D14-19": {
    actionSummary: "NHK受信契約の解約/名義変更、固定電話の解約/名義変更、郵便物の転送届を手続きする",
    whyNeeded: "NHK受信料は放置で請求継続。郵便転送届を出さないと重要書類が届かなくなります。",
    destination: "NHK：電話 / 固定電話：NTT等 / 郵便局",
    requiredDocs: "故人の契約情報（お客様番号等）、届出者の本人確認書類",
    steps: "①NHK→0120-151515に電話し死亡による解約/名義変更/②固定電話→116番に電話し解約/名義変更/③郵便転送→最寄り郵便局で転居届提出（転送1年）/④またはe転居でWeb手続き",
    officeHours: "NHK 9:00-17:00 / NTT 116 9:00-17:00 / 郵便局 平日9:00-17:00",
    address: "",
    phone: "NHK：0120-151515 / NTT：116",
    doneCondition: "NHK・固定電話の解約/名義変更が完了し、郵便転送届が提出済み。",
    faq: "Q.NHK解約に証明書必要？→電話のみで完了が多い/Q.転送期間→1年。延長可/Q.固定電話の番号を残したい→名義変更で引継ぎ可"
  },
  "RN-D14-20": {
    actionSummary: "故人が遺言書を残していないか確認する",
    whyNeeded: "遺言書がある場合はその内容に基づき相続手続きが進みます。無視して分割するとトラブルの原因に。",
    destination: "故人の自宅 / 法務局 / 公証役場",
    requiredDocs: "確認時：特になし / 照会時：本人確認書類、戸籍謄本等",
    steps: "①故人の自宅を探す（仏壇・金庫・書斎等）/②銀行の貸金庫を確認/③法務局で遺言書保管事実証明書を請求/④公証役場の遺言検索システムで公正証書遺言確認/⑤自筆証書遺言（法務局保管以外）は未開封のまま家裁で検認",
    officeHours: "法務局・公証役場：平日 8:30-17:15",
    address: "旭川地方法務局深川支局：北海道深川市3条2番1号",
    phone: "0164-23-3269",
    doneCondition: "遺言書の有無が確認済み。ある場合は検認手続き（必要時）に着手済み。",
    faq: "Q.見つけたら開けていい？→公正証書と法務局保管は開封OK。それ以外は絶対開封しないで。家裁の検認が必要/Q.なかったら→法定相続分で遺産分割協議/Q.内容に不満→遺留分侵害額請求（期限1年）が可能"
  },
  "RN-D14-22": {
    actionSummary: "故人のマイナンバーカード（通知カード）を北竜町役場に返納する",
    whyNeeded: "死亡届提出でカードは無効に。悪用防止のため返納推奨。",
    destination: "北竜町役場 1F 住民課",
    requiredDocs: "故人のマイナンバーカード/通知カード、届出人の本人確認書類",
    steps: "①マイナンバーカードを探す/②北竜町役場住民課に持参して返納/③見つからない場合はその旨を伝える",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "マイナンバーカードを返納済み、または紛失旨を届出済み。",
    faq: "Q.返納しないと罰則？→なし。ただし悪用防止のため推奨/Q.見つからない→窓口にその旨伝えればOK/Q.マイナンバーは相続で使う？→相続税申告等で使う場合あり。番号をメモ"
  },
  "RN-D14-23": {
    actionSummary: "故人の社保の被扶養者だった方は国保加入または自分の勤務先の保険へ切替える",
    whyNeeded: "故人の社保の資格喪失に伴い被扶養者の資格もなくなります。無保険状態を防ぐため速やかに切替えを。",
    destination: "国保：北竜町役場 / 自分の勤務先の社保",
    requiredDocs: "故人の保険証（または資格喪失証明書）、被扶養者の本人確認書類、印鑑",
    steps: "①今後の保険を決める：a)勤務先あり→勤務先の社保 b)なし→国民健康保険/②国保→役場に資格喪失証明書と本人確認書類を持参/③勤務先社保→勤務先の総務に連絡/④任意継続（最長2年）も検討",
    officeHours: "平日 8:30-17:15（役場）",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "被扶養者全員の保険切替えが完了し、新しい保険証を取得済み。",
    faq: "Q.切替え前に受診したら→後から精算可。新保険証を後日病院に提出/Q.国保と任意継続どちらが得→保険料比較を。故人の給与が高ければ国保が安いことが多い/Q.子の保険→国保加入か、もう一方の親の社保扶養に"
  },
  "RN-D14-24": {
    actionSummary: "児童扶養手当やひとり親関連の給付の受給資格を確認・申請する",
    whyNeeded: "月額最大44,140円（子1人）が支給。申請月の翌月分から支給のため早めの申請が有利。",
    destination: "北竜町役場",
    requiredDocs: "請求者と子の戸籍謄本、住民票、所得証明書、振込先口座、年金手帳、印鑑",
    steps: "①役場に電話し「児童扶養手当の申請」を相談/②必要書類を確認/③書類を揃えて窓口で申請/④あわせて確認：ひとり親医療費助成、就学援助、住宅手当/⑤児童手当の受給者変更も確認",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "受給資格確認済み。該当時は申請提出済み。",
    faq: "Q.いくら？→全部支給で月44,140円（子1人）。2人目+10,420円、3人目+6,250円/Q.所得制限→全部支給は年収約160万以下が目安/Q.遺族年金と併給？→遺族年金額が児童扶養手当未満なら差額支給"
  },
  "RN-D49-01": {
    actionSummary: "ご遺骨の納骨先を決め、墓地管理者・寺院に連絡して段取りをつける",
    whyNeeded: "四十九日法要に合わせて納骨する方が多い。法律上の期限はないが、納骨先の確保・日程調整には時間がかかるため早めに。",
    destination: "菩提寺・墓地管理者・霊園",
    requiredDocs: "埋葬許可証",
    steps: "①墓がある→管理者・菩提寺に連絡し納骨日相談/②墓がない→納骨先検討（一般墓/永代供養/樹木葬/散骨/手元供養）/③納骨日・法要日程を決める/④僧侶依頼・お布施準備/⑤親族連絡・出欠確認/⑥当日持参：埋葬許可証・お布施・お花等",
    officeHours: "寺院・霊園による",
    address: "",
    phone: "",
    doneCondition: "納骨先が決まり、納骨日程が確定している。",
    faq: "Q.四十九日までに納骨必須？→法律上の期限なし。自宅安置もOK/Q.墓がない→永代供養、樹木葬、散骨等の選択肢あり/Q.お布施相場→四十九日で3〜5万が目安。お寺に聞いてOK"
  },
  "RN-D49-02": {
    actionSummary: "香典をいただいた方への香典返し（忌明け返し）を手配する",
    whyNeeded: "香典をいただいた方へのお礼。忌明け後に贈るのが一般的なマナーです。",
    destination: "百貨店・ギフトショップ・葬儀社",
    requiredDocs: "香典帳（氏名・金額リスト）",
    steps: "①香典帳を整理（氏名・住所・金額リスト化）/②品物を選ぶ（いただいた額の1/3〜1/2）/③挨拶状を用意/④発送手配/⑤即返し済みの場合は高額香典への追加返しのみ",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "香典返しの品物選定・発送手配が完了。",
    faq: "Q.金額の目安→1/3〜1/2。1万円の香典なら3,000〜5,000円/Q.即返し済みの場合→高額香典の方に差額分の追加返しを検討/Q.何を贈る→消え物（お茶、海苔等）やカタログギフトが一般的/Q.家族葬で香典辞退→受け取っていなければ不要"
  },
  "RN-M3-01": {
    actionSummary: "故人の財産と負債を把握し、相続放棄または限定承認をするかどうか判断する",
    whyNeeded: "3か月以内に家庭裁判所に申述が必要。期限を過ぎると単純承認（負債も全て相続）になります。",
    destination: "旭川家庭裁判所深川支部",
    requiredDocs: "相続放棄申述書、故人の戸籍謄本、住民票の除票、申述人の戸籍謄本、収入印紙800円、郵便切手",
    steps: "①財産（プラス）と負債（マイナス）を把握/②プラスが多い→単純承認（何もしない）/③マイナスが多いor不明→相続放棄を検討/④プラスの範囲で引継ぎたい→限定承認/⑤放棄する場合→家裁に申述書提出/⑥判断つかない→期間伸長の申立て",
    officeHours: "平日 8:30-17:00",
    address: "旭川家庭裁判所深川支部：北海道深川市3条2番1号",
    phone: "0164-23-3269",
    doneCondition: "相続の方針が決定。放棄・限定承認時は家裁に申述済み。",
    faq: "Q.3か月で判断できない→家裁に期間伸長の申立てが可能/Q.放棄すると何が起きる→最初から相続人でなかった扱い。全財産・全負債を引き継がない/Q.一部だけ放棄→不可。全部承認か全部放棄の二択"
  },
  "RN-M3-02": {
    actionSummary: "故人の借金・保証債務・連帯債務を調査し、負債の全体像を把握する",
    whyNeeded: "相続すると負債も引き継ぎ。相続放棄の判断（3か月以内）に間に合うよう早めの調査が重要。",
    destination: "信用情報機関（CIC・JICC・KSC）、故人の自宅",
    requiredDocs: "戸籍謄本、届出者の本人確認書類、死亡確認書類",
    steps: "①自宅で借用書・ローン契約書・督促状を探す/②通帳の引落し記録からローン確認/③信用情報機関に開示請求：CIC・JICC・KSC/④連帯保証の有無を契約書等で確認/⑤結果をリスト化",
    officeHours: "各機関による",
    address: "",
    phone: "CIC：0570-666-414 / JICC：0570-021-717 / KSC：03-3214-5020",
    doneCondition: "負債の全体像が把握されリスト化されている。",
    faq: "Q.相続人でも開示請求可？→はい。戸籍謄本等で請求可/Q.連帯保証人の確認方法→信用情報で一部判明。個人間の保証は記載なし/Q.費用→1機関あたり約1,000円"
  },
  "RN-M3-03": {
    actionSummary: "故人の出生〜死亡の戸籍謄本一式と、相続人全員の戸籍謄本・印鑑証明書を収集する",
    whyNeeded: "ほぼすべての相続手続きで必要な基本書類。出生〜死亡の連続した戸籍で法定相続人を確定します。",
    destination: "故人の本籍地の役場 / 広域交付制度で最寄り役場も可",
    requiredDocs: "請求者の本人確認書類、印鑑、手数料（1通450〜750円）",
    steps: "①故人の本籍地を確認（住民票除票に記載）/②出生〜死亡の連続した戸籍謄本を取得/③転籍がある場合は各本籍地から取得（郵送可）/④相続人全員の現在の戸籍謄本を取得/⑤相続人全員の印鑑証明書を取得/⑥広域交付制度の活用も検討",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1（本籍が北竜町の場合）",
    phone: "0164-34-2111",
    doneCondition: "故人の連続した戸籍と相続人全員の戸籍・印鑑証明書がすべて揃っている。",
    faq: "Q.広域交付とは→2024年3月から本籍地以外の役場でも取得可能に/Q.何通ずつ→法定相続情報一覧図を取得すれば1セットで済む/Q.本籍地が遠方→郵送請求可。広域交付も検討"
  },
  "RN-M3-04": {
    actionSummary: "故人名義の住宅ローン・借入金について金融機関に届出し、団信の適用を確認する",
    whyNeeded: "団信加入なら残債が保険金で完済。届出遅延で遅延損害金が発生するリスクあり。",
    destination: "借入先の金融機関",
    requiredDocs: "死亡診断書コピー、届出人の本人確認書類、戸籍謄本、ローン契約書",
    steps: "①借入先を確認/②借入先に電話し「名義人の死亡」を届出/③団信の加入有無を確認/④団信加入→保険金請求し完済/⑤団信未加入→返済引継ぎか相続放棄を検討/⑥他の借入金も同様に届出",
    officeHours: "各金融機関による",
    address: "",
    phone: "",
    doneCondition: "住宅ローン・借入金の届出完了、団信の適用有無確認済み。",
    faq: "Q.団信に入っているか不明→ローン契約時にほぼ加入。借入先に確認/Q.団信適用でゼロに？→はい。残債全額が保険金で返済/Q.連帯債務→故人分のみ団信で完済。もう一方の債務は残る"
  },
  "RN-M3-05": {
    actionSummary: "法務局に「法定相続情報一覧図」の保管及び交付の申出を行い、認証文付き一覧図を取得する",
    whyNeeded: "戸籍謄本の束を何セットも用意する必要がなくなり、手続きが大幅に効率化。無料で何通でも取得可。",
    destination: "旭川地方法務局深川支局",
    requiredDocs: "故人の戸籍謄本一式、住民票の除票、相続人の住民票、申出人の本人確認書類",
    steps: "①戸籍謄本一式を揃える/②法定相続情報一覧図を作成（法務局Webに記載例）/③申出書を記入/④法務局に提出（郵送可）/⑤1〜2週間後に認証文付き一覧図が交付/⑥必要枚数を申告して取得（無料）",
    officeHours: "平日 8:30-17:15",
    address: "旭川地方法務局深川支局：北海道深川市3条2番1号",
    phone: "0164-23-3269",
    doneCondition: "認証文付き写しを必要枚数取得済み。",
    faq: "Q.自分で作成できる？→はい。法務局Webに記載例あり。手書きもPCもOK/Q.費用→無料。何枚でも無料/Q.司法書士に頼むべき？→自分でも可。不安なら依頼（3〜5万円程度）"
  },
  "RN-M3-07": {
    actionSummary: "故人のプラスの財産とマイナスの財産をすべてリスト化し、財産目録を作成する",
    whyNeeded: "遺産分割協議、相続税申告、相続放棄の判断など、すべての相続手続きの土台となる最重要書類。",
    destination: "",
    requiredDocs: "通帳、証券書類、登記簿、固定資産税通知書、保険証券、借用書、ローン契約書等",
    steps: "①プラスの財産をリスト化（預貯金・不動産・有価証券・保険・自動車等）/②マイナスの財産をリスト化（ローン・借入金・未払い税金・医療費等）/③各財産の評価額を確認（死亡日時点）/④一覧表にまとめる/⑤相続人全員で共有",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "相続財産目録が完成し、相続人全員に共有されている。",
    faq: "Q.評価額の調べ方→預金は残高証明書、不動産は固定資産評価証明書、株式は死亡日終値/Q.財産の所在不明→通帳・郵便物・確定申告書から手がかりを/Q.農地の評価→固定資産税評価額と相続税評価額は異なる。税理士に相談"
  },
  "RN-M3-10": {
    actionSummary: "相続手続きを進める代表者を相続人間で決める",
    whyNeeded: "各機関との窓口を一本化し手続きを効率化。バラバラに動くと混乱の元に。",
    destination: "",
    requiredDocs: "なし",
    steps: "①相続人全員で話し合い代表者を決める/②代表者の役割：連絡窓口・書類管理・相続人間連絡調整・財産管理/③他の相続人から委任状をもらう/④連絡方法（LINEグループ等）を決める",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "代表者が決まり、全相続人に共有されている。",
    faq: "Q.法律上の義務？→義務ではないが実務上はスムーズ/Q.代表者の権限→手続きの窓口。遺産分割の内容を勝手に決める権限はない/Q.意見が合わない→弁護士相談か家裁の調停"
  },
  "RN-M3-11": {
    actionSummary: "相続人全員で遺産の分け方を話し合い、遺産分割協議書を作成する",
    whyNeeded: "不動産の名義変更、銀行口座の解約・払戻し、相続税申告で必要な重要書類。全相続人の合意・署名・実印が必要。",
    destination: "",
    requiredDocs: "相続財産目録、戸籍・印鑑証明書、各相続人の実印",
    steps: "①財産目録をもとに分割を話し合う/②全員合意→遺産分割協議書作成/③記載：被相続人情報・全相続人氏名・各財産の分割内容/④全員が署名・実印押印/⑤印鑑証明書を添付/⑥複数部作成",
    officeHours: "",
    address: "",
    phone: "",
    doneCondition: "協議書が完成し、全相続人の署名・実印・印鑑証明書が揃っている。",
    faq: "Q.相続人が遠方→郵送リレー方式（署名・押印して次の人に）/Q.まとまらない→家裁の遺産分割調停。弁護士への相談も/Q.自分で作成可？→可能だが不動産ありは司法書士推奨"
  },
  "RN-M3-12": {
    actionSummary: "故人名義の農地について北竜町農業委員会に届出する",
    whyNeeded: "農地法により届出が義務。届出を怠ると10万円以下の過料の対象。",
    destination: "北竜町農業委員会（役場内）",
    requiredDocs: "届出書、登記事項証明書（または遺産分割協議書コピー）、届出者の本人確認書類",
    steps: "①故人名義の農地を確認（固定資産税通知書）/②役場内の農業委員会に連絡/③届出書を入手・記入/④必要書類添付して提出/⑤耕作できない場合は農業委員会に相談（あっせん・貸付制度あり）",
    officeHours: "平日 8:30-17:15",
    address: "北海道雨竜郡北竜町字和11-1",
    phone: "0164-34-2111",
    doneCondition: "農業委員会への届出が完了。",
    faq: "Q.農業やるつもりがない→届出は必要。耕作不可の旨を相談。農地中間管理機構への貸付等あり/Q.届出しないと→10万円以下の過料/Q.農地売却したい→農業委員会の許可が必要/Q.北竜町の特別制度→空知管内に農地中間管理機構の出先あり"
  },
  "RN-M4-01": {
    actionSummary: "故人の1月1日〜死亡日の所得について、相続人が代わりに確定申告（準確定申告）する",
    whyNeeded: "一定の所得がある場合4か月以内に申告義務。無申告で加算税・延滞税のリスク。",
    destination: "深川税務署",
    requiredDocs: "源泉徴収票、確定申告関連書類（医療費領収書・保険料控除証明書等）、本人確認書類、「確定申告書付表」",
    steps: "①準確定申告の要否を判断/②必要なら所得計算/③確定申告書と付表を作成/④相続人全員が署名/⑤深川税務署に提出（郵送可）",
    officeHours: "平日 8:30-17:00",
    address: "深川税務署：北海道深川市2条17番17号",
    phone: "0164-23-2191",
    doneCondition: "要否判定済み。必要な場合は申告書提出済み。",
    faq: "Q.年金のみの収入→400万以下で他の所得20万以下なら原則不要。医療費控除の還付が受けられる場合は申告推奨/Q.自分でできる？→単純ケースなら可。不動産・事業所得は税理士推奨/Q.期限超過→期限後申告は可能だが加算税・延滞税あり"
  },
  "RN-M10-01": {
    actionSummary: "相続財産の総額が基礎控除額を超えるか確認し、相続税申告の要否を判定する",
    whyNeeded: "基礎控除（3,000万+600万×相続人数）を超える場合のみ課税。超える場合は10か月以内に申告・納付。",
    destination: "深川税務署",
    requiredDocs: "相続財産目録、不動産評価書類、残高証明書等",
    steps: "①基礎控除額を計算/②財産総額と比較/③総額≦基礎控除→申告不要/④総額＞基礎控除→申告必要、税理士に依頼推奨/⑤特例適用で税額ゼロでも申告は必要",
    officeHours: "平日 8:30-17:00",
    address: "深川税務署：北海道深川市2条17番17号",
    phone: "0164-23-2191",
    doneCondition: "要否判定済み。必要な場合は税理士に依頼済みまたは準備中。",
    faq: "Q.相続人2人の非課税枠→4,200万円まで/Q.税理士費用→遺産総額の0.5〜1%が目安/Q.農地の特別扱い→農業相続人に「納税猶予の特例」あり"
  },
  "RN-M10-05": {
    actionSummary: "遺産分割協議確定後、故人名義の銀行口座の解約・払戻しを行う",
    whyNeeded: "口座凍結後の預金は遺産分割協議書等を提出しないと引き出せません。",
    destination: "各銀行の窓口",
    requiredDocs: "遺産分割協議書/遺言書、戸籍謄本一式/法定相続情報一覧図、相続人全員の印鑑証明書、本人確認書類、通帳・カード、銀行所定の相続届出書",
    steps: "①各銀行から相続届出書を入手/②必要書類を揃える/③銀行窓口で手続き/④払戻し先口座を指定/⑤通常1〜3週間で振込/⑥解約完了を確認",
    officeHours: "平日 9:00-15:00（窓口）",
    address: "",
    phone: "",
    doneCondition: "全銀行口座の解約・払戻し完了、相続人口座に振込済み。",
    faq: "Q.遺産分割前に一部引出可？→相続預金の払戻し制度で各口座残高×1/3×法定相続分（上限150万）まで/Q.通帳紛失→通帳なしで手続き可/Q.銀行ごとに個別手続き？→はい。法定相続情報一覧図があると効率的"
  },
  "RN-M10-07": {
    actionSummary: "故人名義の自動車の名義変更（移転登録）または廃車（抹消登録）を行う",
    whyNeeded: "故人名義のままでは車検更新や売却不可。自動車税の納付義務も残ります。",
    destination: "普通車：旭川運輸支局 / 軽：軽自動車検査協会",
    requiredDocs: "車検証、故人の戸籍謄本、遺産分割協議書、相続人の印鑑証明書・車庫証明書・委任状",
    steps: "①車検証で故人名義を確認/②相続→名義変更/③廃車→抹消登録/④普通車→旭川運輸支局/⑤軽→軽自動車検査協会旭川事務所/⑥自動車保険の名義変更も忘れずに/⑦廃車時は自動車税還付確認",
    officeHours: "平日 8:45-16:00（運輸支局）",
    address: "旭川運輸支局：北海道旭川市春光町10番地",
    phone: "050-5540-2003",
    doneCondition: "名義変更/廃車手続きが完了。",
    faq: "Q.売却したい→まず名義変更してから売却/Q.自動車税→名義変更で新所有者に課税。廃車は月割還付/Q.代行依頼→ディーラー・行政書士に1〜3万程度"
  },
  "RN-M10-08": {
    actionSummary: "故人の運転免許証を最寄りの警察署に返納する",
    whyNeeded: "法律上の義務ではないが悪用防止のため推奨。返納しない場合はハサミで裁断処分。",
    destination: "深川警察署",
    requiredDocs: "故人の運転免許証、届出人の本人確認書類（求められる場合）",
    steps: "①運転免許証を探す/②深川警察署に持参して返納/③手元に残したい→穴あけ処理が可能な場合あり/④返納しない→ICチップ部分を裁断して処分",
    officeHours: "平日 8:30-17:15",
    address: "深川警察署：北海道深川市4条8番20号",
    phone: "0164-22-0110",
    doneCondition: "運転免許証を返納済みまたは裁断処分済み。",
    faq: "Q.罰則は→なし。悪用防止で推奨/Q.記念に残したい→穴あけ処理で返却してもらえる場合あり/Q.本人確認書類として使えた？→死亡後は使えない"
  },
  "RN-Y3-01": {
    actionSummary: "故人名義の不動産（土地・建物）の名義を相続人に変更する相続登記を法務局に申請する",
    whyNeeded: "2024年4月から義務化。3年以内に申請しないと10万円以下の過料。登記しないと売却・担保設定不可。",
    destination: "旭川地方法務局深川支局",
    requiredDocs: "登記申請書、戸籍謄本一式/法定相続情報一覧図、遺産分割協議書/遺言書、印鑑証明書、固定資産評価証明書、住民票、登録免許税（評価額の0.4%）",
    steps: "①固定資産評価証明書を北竜町役場で取得/②登記申請書を作成/③必要書類を揃える/④登録免許税を計算/⑤法務局に申請（窓口/郵送）/⑥1〜2週間で完了/⑦登記識別情報通知を受取り保管",
    officeHours: "平日 8:30-17:15",
    address: "旭川地方法務局深川支局：北海道深川市3条2番1号",
    phone: "0164-23-3269",
    doneCondition: "全不動産の相続登記が完了し、登記識別情報通知を受領済み。",
    faq: "Q.自分でできる？→単純な案件なら可。法務局の「登記手続案内」（予約制）で無料相談あり/Q.司法書士費用→1件5〜10万程度/Q.登録免許税→評価額の0.4%。1,000万なら4万/Q.農地も→はい。農業委員会届出とは別に登記も必要/Q.固定資産評価証明書→北竜町役場で取得可（約300円）"
  }
};

        // オンボーディングで表示する質問ID（7問）
        const onboardingQuestionIds = [
            'Q-REL-01',
            'Q-DOD-01',
            'Q-EMP-01',
            'Q-DECEASED-EMP-01',
            'Q-DIG-01',
            'Q-FUN-STATUS-01',
            'Q-ADMIN-DN-01'
        ];
        let onboardingQuestions = [];

        // 確認センター用（残り19問）
        let confirmQuestions = [];
        let currentConfirmIndex = 0;
        let confirmDirection = 'forward'; // 'forward' or 'back'
        let confirmSourceScreen = 'screen-home'; // 遷移元の画面
        let confirmTaskId = null; // NEED_CONFIRMタスクから遷移した場合のタスクID

        // 状態管理
        let answers = {};
        let currentQuestionIndex = 0;
        let taskStatuses = {};
        let currentGuideView = 'phase';
        let currentTaskId = null;

        // ローカルストレージから復元
        function loadData() {
            const savedAnswers = localStorage.getItem('answers');
            const savedStatuses = localStorage.getItem('taskStatuses');
            if (savedAnswers) answers = JSON.parse(savedAnswers);
            if (savedStatuses) taskStatuses = JSON.parse(savedStatuses);
        }

        function saveData() {
            localStorage.setItem('answers', JSON.stringify(answers));
            localStorage.setItem('taskStatuses', JSON.stringify(taskStatuses));
        }

        // 画面遷移
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            // フローティング相談ボタンの表示制御
            const floatingBtn = document.getElementById('floatingConsultBtn');
            const screensWithFloatingBtn = ['screen-home', 'screen-guide', 'screen-confirm', 'screen-settings', 'screen-concierge'];
            if (screensWithFloatingBtn.includes(screenId)) {
                floatingBtn.classList.add('show');
            } else {
                floatingBtn.classList.remove('show');
            }

            // フッターナビの表示制御
            const footerNav = document.querySelector('.footer-nav');
            const screensWithoutFooter = ['screen-splash', 'screen-onboarding'];
            if (footerNav) {
                if (screensWithoutFooter.includes(screenId)) {
                    footerNav.style.display = 'none';
                } else {
                    footerNav.style.display = 'flex';
                }
            }

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (screenId === 'screen-home') {
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                updateUserNameDisplay();
                renderHome();
            } else if (screenId === 'screen-guide') {
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                renderGuide();

                // スクロール位置を復元
                requestAnimationFrame(() => {
                    const guideScreen = document.getElementById('screen-guide');
                    if (guideScreen && window._guideScrollTop) {
                        guideScreen.scrollTop = window._guideScrollTop;
                    }
                });
            } else if (screenId === 'screen-detail') {
                // タスク詳細画面はスクロール位置を先頭にリセット
                requestAnimationFrame(() => {
                    const detailScreen = document.getElementById('screen-detail');
                    if (detailScreen) {
                        detailScreen.scrollTop = 0;
                    }
                });
            } else if (screenId === 'screen-concierge') {
                document.querySelectorAll('.nav-item')[2].classList.add('active');
            } else if (screenId === 'screen-settings') {
                updateUserNameDisplay();
            } else if (screenId === 'screen-confirm') {
                // 確認センターを表示
                document.getElementById('confirmQuestionArea').style.display = 'block';
                startConfirmCenter();
            }
        }

        // タブ切り替え
        function switchTab(tab) {
            if (tab === 'home') {
                showScreen('screen-home');
            } else if (tab === 'guide') {
                showScreen('screen-guide');
            } else if (tab === 'concierge') {
                showScreen('screen-concierge');
            }
        }

        // LINE公式アカウントを開く
        function openLineOA() {
            window.open(LINE_OA_URL, '_blank');
        }

        // 電話をかける
        function callPhone() {
            window.location.href = 'tel:0164342111';
        }

        // オンボーディング（質問）
        function startOnboarding() {
            // オンボーディング用の7問をフィルタ
            onboardingQuestions = questions.filter(q => onboardingQuestionIds.includes(q.id));
            // onboardingQuestionIds の順番通りにソート
            onboardingQuestions.sort((a, b) => {
                return onboardingQuestionIds.indexOf(a.id) - onboardingQuestionIds.indexOf(b.id);
            });
            // Index -1 = name input step, Index 0-6 = 7 questions (total 8 steps)
            currentQuestionIndex = -1;
            showScreen('screen-onboarding');
            renderQuestion();
        }

        function renderQuestion() {
            const card = document.getElementById('questionCard');

            // Step 1/8: Name input (index -1)
            if (currentQuestionIndex === -1) {
                const savedName = localStorage.getItem('rn_user_name') || '';
                let html = '<div class="name-input-form">';
                html += '<div class="question-text">お名前を教えてください</div>';
                html += '<div class="question-info">1 / 8 ※後から変更できます</div>';
                html += `<input type="text" id="nameInput" class="name-input" placeholder="例：田中" maxlength="20" value="${savedName}">`;
                html += '<div class="name-input-actions">';
                const hasName = savedName.trim().length > 0;
                const btnDisabled = hasName ? '' : 'disabled';
                const btnStyle = hasName ? '' : 'style="opacity: 0.3; pointer-events: none;"';
                html += `<button class="btn-primary" id="nameSubmitBtn" onclick="submitNameInFlow()" ${btnDisabled} ${btnStyle}>次へ</button>`;
                html += '<button class="btn-skip-name" onclick="skipNameInFlow()">名前を入れずに始める</button>';
                html += '</div>';
                html += '</div>';
                card.innerHTML = html;

                // Add input listener for enabling/disabling button
                setTimeout(() => {
                    const nameInput = document.getElementById('nameInput');
                    const nameSubmitBtn = document.getElementById('nameSubmitBtn');
                    if (nameInput && nameSubmitBtn) {
                        nameInput.addEventListener('input', () => {
                            if (nameInput.value.trim().length > 0) {
                                nameSubmitBtn.disabled = false;
                                nameSubmitBtn.style.opacity = '1';
                                nameSubmitBtn.style.pointerEvents = 'auto';
                            } else {
                                nameSubmitBtn.disabled = true;
                                nameSubmitBtn.style.opacity = '0.3';
                                nameSubmitBtn.style.pointerEvents = 'none';
                            }
                        });
                    }
                }, 0);
                return;
            }

            // Steps 2-8/8: Questions (index 0-6)
            const q = onboardingQuestions[currentQuestionIndex];
            const totalSteps = onboardingQuestions.length + 1; // +1 for name input
            const currentStep = currentQuestionIndex + 2; // +2 because index 0 is step 2

            let html = `<div class="domain-badge domain-${q.domain}">${domainLabels[q.domain]}</div>`;
            html += `<div class="question-text">${q.text}</div>`;
            html += `<div class="question-info">${currentStep} / ${totalSteps} ※後から変更できます</div>`;

            if (q.type === 'single') {
                q.options.forEach(opt => {
                    const selected = answers[q.id] === opt.value ? 'selected' : '';
                    html += `<button class="option-btn ${selected}" onclick="selectSingle('${q.id}', '${opt.value}')">${opt.label}</button>`;
                });
                html += `<a class="skip-link" onclick="skipQuestion()">あとで回答する</a>`;
            } else if (q.type === 'multi') {
                q.options.forEach(opt => {
                    const selected = answers[q.id] && answers[q.id].includes(opt.value) ? 'selected' : '';
                    html += `<button class="option-btn ${selected}" onclick="selectMulti('${q.id}', '${opt.value}')">${opt.label}</button>`;
                });

                // 次へボタン
                const isLastQuestion = currentQuestionIndex === onboardingQuestions.length - 1;
                const hasSelection = answers[q.id] && answers[q.id].length > 0;
                const btnText = isLastQuestion ? '完了' : '次へ';
                const btnDisabled = hasSelection ? '' : 'disabled';
                const btnStyle = hasSelection ? '' : 'style="opacity: 0.3; pointer-events: none;"';

                html += `<button class="btn-primary" id="nextBtn" onclick="nextQuestion()" ${btnDisabled} ${btnStyle} style="margin-top: 32px;">${btnText}</button>`;
                html += `<a class="skip-link" onclick="skipQuestion()" style="margin-top: 16px; display: block;">あとで回答する</a>`;
            } else if (q.type === 'date') {
                const value = answers[q.id] || '';
                html += `<input type="date" class="date-input" id="dateInput" value="${value}" onchange="selectDate('${q.id}', this.value)">`;

                // 次へボタン
                const isLastQuestion = currentQuestionIndex === onboardingQuestions.length - 1;
                const hasDate = answers[q.id] && answers[q.id].trim() !== '';
                const btnText = isLastQuestion ? '完了' : '次へ';
                const btnDisabled = hasDate ? '' : 'disabled';
                const btnStyle = hasDate ? '' : 'style="opacity: 0.3; pointer-events: none;"';

                html += `<button class="btn-primary" id="nextBtn" onclick="nextQuestion()" ${btnDisabled} ${btnStyle} style="margin-top: 32px;">${btnText}</button>`;
                html += `<a class="skip-link" onclick="skipQuestion()" style="margin-top: 16px; display: block;">あとで回答する</a>`;
            }

            card.innerHTML = html;
        }

        function selectSingle(qid, value) {
            answers[qid] = value;
            saveData();
            regenerateAllTaskStatuses(); // ルールエンジン再実行
            nextQuestion();
        }

        function selectMulti(qid, value) {
            if (!answers[qid]) answers[qid] = [];

            if (value === 'NONE' || value === 'UNKNOWN') {
                // NONE/UNKNOWNを選択 → 他の選択肢を全て解除
                answers[qid] = [value];
            } else {
                // 具体的な選択肢を選択 → NONE/UNKNOWNを解除
                answers[qid] = answers[qid].filter(v => v !== 'NONE' && v !== 'UNKNOWN');
                const index = answers[qid].indexOf(value);
                if (index > -1) {
                    answers[qid].splice(index, 1);
                } else {
                    answers[qid].push(value);
                }
            }

            saveData();
            regenerateAllTaskStatuses(); // ルールエンジン再実行
            renderQuestion();
        }

        function selectDate(qid, value) {
            answers[qid] = value;
            saveData();
            regenerateAllTaskStatuses(); // ルールエンジン再実行
            renderQuestion(); // 次へボタンを活性化
        }

        function submitNameInFlow() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            if (name) {
                localStorage.setItem('rn_user_name', name);
                nextQuestion(); // Move to first question
            }
        }

        function skipNameInFlow() {
            localStorage.setItem('rn_user_name', 'ゲスト');
            nextQuestion(); // Move to first question
        }

        function prevQuestion() {
            if (currentQuestionIndex > -1) {
                currentQuestionIndex--;
                renderQuestion();
            } else {
                // Already at name input step (-1), go back to splash
                showScreen('screen-splash');
            }
        }

        function skipQuestion() {
            nextQuestion();
        }

        function nextQuestion() {
            if (currentQuestionIndex < onboardingQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                // オンボーディング完了（8ステップ完了: 名前 + 7問）
                generateTasks();
                renderHome();
                showScreen('screen-home');
            }
        }

        // タスクルールエンジン（完全準拠版）
        function evaluateCondition(condition, answersData) {
            if (!condition || condition === 'true' || condition === true) return true;
            if (condition === 'null' || condition === null) return false;

            const ans = answersData || answers;

            // containsAny: Q-DIG-01.containsAny('MOBILE','NET','SUBSCRIPTIONS','ACCOUNTS')
            const containsAnyMatch = condition.match(/^(Q-[\w-]+)\.containsAny\((.+)\)$/);
            if (containsAnyMatch) {
                const qid = containsAnyMatch[1];
                const values = containsAnyMatch[2].split(',').map(v => v.trim().replace(/'/g, '').replace(/"/g, ''));
                const answer = ans[qid];
                if (!answer) return false;
                if (Array.isArray(answer)) return values.some(v => answer.includes(v));
                return values.includes(answer);
            }

            // includes: Q-FIN-01.includes('NONE')
            const includesMatch = condition.match(/^(Q-[\w-]+)\.includes\('(\w+)'\)$/);
            if (includesMatch) {
                const qid = includesMatch[1];
                const val = includesMatch[2];
                const answer = ans[qid];
                if (!answer) return false;
                if (Array.isArray(answer)) return answer.includes(val);
                return answer === val;
            }

            // 配列includes: ['COMPLETED','NO_FUNERAL'].includes(Q-FUN-STATUS-01)
            const arrayIncludesMatch = condition.match(/^\[(.+)\]\.includes\((Q-[\w-]+)\)$/);
            if (arrayIncludesMatch) {
                const values = arrayIncludesMatch[1].split(',').map(v => v.trim().replace(/'/g, '').replace(/"/g, ''));
                const qid = arrayIncludesMatch[2];
                const answer = ans[qid];
                if (!answer) return false;
                const answerVal = Array.isArray(answer) ? answer[0] : answer;
                return values.includes(answerVal);
            }

            // 等価比較: Q-HOUSEHOLD-01=='YES'
            const eqMatch = condition.match(/^(Q-[\w-]+)==[=]?'(\w+)'$/);
            if (eqMatch) {
                const qid = eqMatch[1];
                const val = eqMatch[2];
                const answer = ans[qid];
                if (!answer) return false;
                if (Array.isArray(answer)) return answer.includes(val);
                return answer === val;
            }

            // 不等価比較: Q-HI-01!='EHI'
            const neqMatch = condition.match(/^(Q-[\w-]+)!='(\w+)'$/);
            if (neqMatch) {
                const qid = neqMatch[1];
                const val = neqMatch[2];
                const answer = ans[qid];
                if (!answer) return true; // 未回答は「等しくない」とみなす
                if (Array.isArray(answer)) return !answer.includes(val);
                return answer !== val;
            }

            // AND結合: Q-HI-01=='EHI'&&Q-DEPENDENT-01=='YES'
            if (condition.includes('&&')) {
                const parts = condition.split('&&').map(p => p.trim());
                return parts.every(part => evaluateCondition(part, ans));
            }

            // OR結合: Q-SPOUSE-01=='YES'||Q-CHILD-U18-01=='YES'
            if (condition.includes('||')) {
                const parts = condition.split('||').map(p => p.trim());
                return parts.some(part => evaluateCondition(part, ans));
            }

            return false;
        }

        function determineTaskStatus(task) {
            // 既にDONEなら維持
            if (taskStatuses[task.id] === 'DONE') return 'DONE';

            // Step 1: required_questionsの回答有無を確認
            if (task.requiredQuestions && task.requiredQuestions.length > 0) {
                const hasAllAnswers = task.requiredQuestions.every(qid => {
                    const answer = answers[qid];
                    return answer !== undefined && answer !== null && answer !== '';
                });
                if (!hasAllAnswers) {
                    // 未回答あり → fallbackStatusで返す（Step 2以降スキップ）
                    return task.fallbackStatus || 'NEED_CONFIRM';
                }
            }

            // Step 2: not_applicable_whenを評価
            if (task.notApplicableWhen && task.notApplicableWhen !== null) {
                if (evaluateCondition(task.notApplicableWhen, answers)) {
                    return 'NOT_APPLICABLE';
                }
            }

            // Step 3: applies_whenを評価
            if (task.appliesWhen) {
                if (evaluateCondition(task.appliesWhen, answers)) {
                    // OPENに確定（Step 5でBLOCKED判定は後で行う）
                    let status = 'OPEN';

                    // Step 5: depends_onを評価（最後に適用）
                    if (task.dependsOn && task.dependsOn.length > 0) {
                        const hasIncompleteDepends = task.dependsOn.some(depId => {
                            const depStatus = taskStatuses[depId];
                            return depStatus !== 'DONE';
                        });
                        if (hasIncompleteDepends) {
                            status = 'BLOCKED';
                        }
                    }

                    return status;
                }
            }

            // Step 4: どちらにも合致しない場合 → fallbackStatus
            let status = task.fallbackStatus || 'NEED_CONFIRM';

            // Step 5: depends_onを評価（fallbackStatusの場合も適用）
            if (task.dependsOn && task.dependsOn.length > 0) {
                const hasIncompleteDepends = task.dependsOn.some(depId => {
                    const depStatus = taskStatuses[depId];
                    return depStatus !== 'DONE';
                });
                if (hasIncompleteDepends) {
                    status = 'BLOCKED';
                }
            }

            return status;
        }

        function generateTasks() {
            // 全タスクのステータスを生成（DONEは維持）
            tasks.forEach(task => {
                if (taskStatuses[task.id] !== 'DONE') {
                    taskStatuses[task.id] = determineTaskStatus(task);
                }
            });
            saveData();
        }

        // 経過週数計算
        function calculateWeeks() {
            const deathDate = answers['Q-DOD-01'];
            if (!deathDate) return '--';

            const death = new Date(deathDate);
            const now = new Date();
            const diffTime = Math.abs(now - death);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weeks = Math.floor(diffDays / 7) + 1;
            return weeks;
        }

        // ホーム画面レンダリング
        function renderHome() {
            // 挨拶文を時間帯で切り替え
            const hour = new Date().getHours();
            let greeting = 'こんにちは、';
            if (hour >= 5 && hour < 12) {
                greeting = 'おはようございます、';
            } else if (hour >= 12 && hour < 18) {
                greeting = 'おつかれさまです、';
            } else {
                greeting = 'おつかれさまです、';
            }
            document.getElementById('greetingText').textContent = greeting;

            // 経過週数
            const weeks = calculateWeeks();
            document.getElementById('weeksDisplay').textContent = `${weeks}週目`;

            // 進捗バー計算
            const allTasks = tasks.map(t => ({
                ...t,
                status: taskStatuses[t.id] || determineTaskStatus(t)
            })).filter(t => t.status !== 'NOT_APPLICABLE');

            const completedCount = allTasks.filter(t => t.status === 'DONE').length;
            const totalCount = allTasks.length;
            const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

            const progressContainer = document.getElementById('homeProgress');
            progressContainer.innerHTML = `
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div class="progress-text">${completedCount}件完了 / 全${totalCount}件</div>
            `;

            // 今日やること（OPEN/NEED_CONFIRMのタスクからpriority上位3件）
            // BLOCKED, DONE, NOT_APPLICABLEは除外
            const activeTasks = tasks.filter(t => {
                const status = taskStatuses[t.id] || determineTaskStatus(t);
                return status === 'OPEN' || status === 'NEED_CONFIRM';
            }).sort((a, b) => b.priority - a.priority).slice(0, 3);

            const todayContainer = document.getElementById('todayTasks');
            if (activeTasks.length === 0) {
                todayContainer.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: 32px 20px; font-size: 15px;">すべてのタスクが完了しました</div>';
            } else {
                // 死亡日から期限計算
                const deathDate = answers['Q-DOD-01'];
                let deathDateObj = null;

                if (deathDate) {
                    if (deathDate.includes('-')) {
                        const parts = deathDate.split('-');
                        deathDateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    } else {
                        deathDateObj = new Date(deathDate);
                    }
                }

                todayContainer.innerHTML = activeTasks.map(task => {
                    const status = taskStatuses[task.id] || determineTaskStatus(task);
                    const isDone = status === 'DONE';

                    // 期限表示計算
                    let deadlineDisplay = '';
                    let deadlineClass = '';

                    if (deathDateObj && task.phase) {
                        const phaseConfig = {
                            'H24': { days: 0 },
                            'D7': { days: 7 },
                            'D14': { days: 14 },
                            'D49': { days: 49 },
                            'M3': { days: 90 },
                            'M4': { days: 120 },
                            'M10': { days: 300 },
                            'Y3': { days: 1095 }
                        };

                        const config = phaseConfig[task.phase];
                        if (config) {
                            const deadlineDate = new Date(deathDateObj);
                            deadlineDate.setDate(deadlineDate.getDate() + config.days);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            deadlineDate.setHours(0, 0, 0, 0);
                            const daysRemaining = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

                            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                            const deadlineMonth = monthNames[deadlineDate.getMonth()];
                            const deadlineDay = deadlineDate.getDate();

                            if (daysRemaining < 0) {
                                deadlineDisplay = `期限を${Math.abs(daysRemaining)}日超過`;
                                deadlineClass = 'warning';
                            } else if (daysRemaining === 0) {
                                deadlineDisplay = `期限: 今日まで`;
                                deadlineClass = 'warning';
                            } else if (daysRemaining <= 7) {
                                deadlineDisplay = `期限: ${deadlineMonth}${deadlineDay}日まで（あと${daysRemaining}日）`;
                                deadlineClass = 'warning';
                            } else {
                                deadlineDisplay = `期限: ${deadlineMonth}${deadlineDay}日まで（あと${daysRemaining}日）`;
                            }
                        }
                    } else if (task.phase) {
                        // 死亡日未回答の場合
                        const phaseNames = {
                            'H24': '当日',
                            'D7': '7日以内',
                            'D14': '14日以内',
                            'D49': '49日以内',
                            'M3': '3ヶ月以内',
                            'M4': '4ヶ月以内',
                            'M10': '10ヶ月以内',
                            'Y3': '3年以内'
                        };
                        deadlineDisplay = `期限: ${phaseNames[task.phase] || ''}`;
                    }

                    // ステータス表示
                    let statusHint = '';
                    if (status === 'NEED_CONFIRM') {
                        statusHint = '<div class="task-status-hint need-confirm">質問に回答すると確定します</div>';
                    } else if (status === 'BLOCKED') {
                        statusHint = '<div class="task-status-hint blocked">前のタスクを完了してください</div>';
                    }

                    // Priority表示（priority >= 85の場合のみ）
                    const priorityBadge = task.priority >= 85
                        ? '<span style="display: inline-block; font-size: 10px; font-weight: 600; color: #c45a3c; background: #fef0ec; padding: 1px 6px; border-radius: 8px; margin-left: 4px;">優先</span>'
                        : '';

                    // 矢印表示（NEED_CONFIRMの場合は非表示）
                    const showArrow = status !== 'NEED_CONFIRM';

                    // クリックハンドラ
                    const clickHandler = status === 'NEED_CONFIRM'
                        ? `openQuestionsForTask('${task.id}', 'screen-home')`
                        : `showTaskDetail('${task.id}')`;

                    return `
                        <div class="task-item" onclick="event.stopPropagation(); ${clickHandler}">
                            <input type="checkbox" class="task-checkbox" ${isDone ? 'checked' : ''} ${status === 'NEED_CONFIRM' || status === 'BLOCKED' ? 'disabled' : ''} onclick="event.stopPropagation(); toggleTaskStatus('${task.id}')">
                            <div class="task-info">
                                <div class="task-name ${isDone ? 'done' : ''}">${task.title}${priorityBadge}</div>
                                ${statusHint}
                                ${deadlineDisplay ? `<div class="task-deadline-display ${deadlineClass}">${deadlineDisplay}</div>` : ''}
                            </div>
                            ${showArrow ? '<div style="color: var(--text-tertiary); font-size: 14px;">›</div>' : ''}
                        </div>
                    `;
                }).join('');
            }

            // 未回答質問の導線
            const allQuestions = confirmQuestions;
            const answeredCount = allQuestions.filter(q => answers[q.id]).length;
            const unansweredCount = allQuestions.length - answeredCount;

            const unansweredCard = document.getElementById('unansweredQuestionsCard');
            if (unansweredCount > 0) {
                unansweredCard.style.display = 'flex';
                unansweredCard.innerHTML = `
                    <div class="unanswered-questions-text">未回答の質問が${unansweredCount}件あります</div>
                    <div class="unanswered-questions-action">回答する →</div>
                `;
            } else {
                unansweredCard.style.display = 'none';
            }
        }

        // ガイド画面レンダリング
        function renderGuide() {
            const container = document.getElementById('guideContent');

            if (currentGuideView === 'phase') {
                // フェーズ別表示
                renderGuideByPhase(container);
            } else if (currentGuideView === 'domain') {
                // 行き先順表示
                renderGuideByDestination(container);
            }
        }

        function renderGuideByPhase(container) {
            const phaseOrder = ['H24', 'D7', 'D14', 'D49', 'M3', 'M4', 'M10', 'Y3'];
            let html = '';

            phaseOrder.forEach((phaseId, index) => {
                const phaseTasks = tasks.filter(t => t.phase === phaseId).map(t => ({
                    ...t,
                    status: taskStatuses[t.id] || determineTaskStatus(t)
                })).filter(t => t.status !== 'NOT_APPLICABLE');

                if (phaseTasks.length === 0) return;

                // ステータス順 + priority降順でソート
                const statusOrder = { 'OPEN': 1, 'NEED_CONFIRM': 2, 'BLOCKED': 3, 'DONE': 4 };
                phaseTasks.sort((a, b) => {
                    const statusDiff = statusOrder[a.status] - statusOrder[b.status];
                    if (statusDiff !== 0) return statusDiff;
                    return b.priority - a.priority; // 同一ステータス内でpriority降順
                });

                const incompleteTasks = phaseTasks.filter(t => t.status !== 'DONE');
                const completedTasks = phaseTasks.filter(t => t.status === 'DONE');

                // 開閉状態を復元（デフォルトは最初のフェーズのみ開く）
                const key = 'deadline_' + phaseId;
                const isOpen = window._accordionState[key] !== undefined ? window._accordionState[key] : (index === 0);
                const openClass = isOpen ? ' open' : '';

                // 完了したタスクの開閉状態を復元（デフォルトは閉じる）
                const completedKey = 'completed_deadline_' + phaseId;
                const isCompletedOpen = window._accordionState[completedKey] || false;
                const completedOpenClass = isCompletedOpen ? ' open' : '';

                html += `
                    <div class="phase-section${openClass}" data-phase-id="${phaseId}" onclick="togglePhase(this)">
                        <div class="phase-header">
                            <div class="phase-title-row">
                                <span class="phase-title">${phases[phaseId]}</span>
                                ${incompleteTasks.length > 0 ? `<span class="task-count-badge">${incompleteTasks.length}</span>` : ''}
                            </div>
                            <span class="phase-arrow">▼</span>
                        </div>
                        <div class="phase-tasks">
                            ${renderTaskList(incompleteTasks)}
                            ${completedTasks.length > 0 ? `
                                <div class="completed-tasks-section${completedOpenClass}" data-completed-id="${phaseId}" onclick="event.stopPropagation(); toggleCompletedTasks(this)">
                                    <div class="completed-tasks-header">
                                        <span>完了したタスク (${completedTasks.length})</span>
                                        <span class="completed-arrow">▼</span>
                                    </div>
                                    <div class="completed-tasks-list">
                                        ${renderTaskList(completedTasks, true)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderGuideByDestination(container) {
            let html = '';

            destinationGroups.forEach((group, index) => {
                // このグループに属するタスクを取得
                const groupTasks = tasks.map(t => ({
                    ...t,
                    status: taskStatuses[t.id] || determineTaskStatus(t),
                    destGroup: getTaskDestinationGroup(t)
                })).filter(t => t.destGroup === group.id && t.status !== 'NOT_APPLICABLE');

                if (groupTasks.length === 0) return;

                // ステータス順 + priority降順でソート
                const statusOrder = { 'OPEN': 1, 'NEED_CONFIRM': 2, 'BLOCKED': 3, 'DONE': 4 };
                groupTasks.sort((a, b) => {
                    const statusDiff = statusOrder[a.status] - statusOrder[b.status];
                    if (statusDiff !== 0) return statusDiff;
                    return b.priority - a.priority; // 同一ステータス内でpriority降順
                });

                const incompleteTasks = groupTasks.filter(t => t.status !== 'DONE');
                const completedTasks = groupTasks.filter(t => t.status === 'DONE');

                // ヒントカード（北竜町役場のみ）
                let hintCard = '';
                if (group.id === 'hokuryu_yakuba' && incompleteTasks.length > 0) {
                    hintCard = `
                        <div style="background: var(--accent-light); padding: 12px 16px; margin: 0 0 12px 0; border-radius: 12px; font-size: 13px; line-height: 1.6; color: var(--text-primary);">
                            これらの手続きは役場への1回の来庁でまとめて行えます。事前に電話（0164-34-2111）で持参物を確認しましょう。
                        </div>
                    `;
                }

                // 開閉状態を復元（デフォルトは最初のグループのみ開く）
                const key = 'dest_' + group.id;
                const isOpen = window._accordionState[key] !== undefined ? window._accordionState[key] : (index === 0);
                const openClass = isOpen ? ' open' : '';

                // 完了したタスクの開閉状態を復元（デフォルトは閉じる）
                const completedKey = 'completed_dest_' + group.id;
                const isCompletedOpen = window._accordionState[completedKey] || false;
                const completedOpenClass = isCompletedOpen ? ' open' : '';

                html += `
                    <div class="phase-section${openClass}" data-phase-id="${group.id}" onclick="togglePhase(this)">
                        <div class="phase-header">
                            <div class="phase-title-row">
                                <span style="font-size: 14px; margin-right: 8px; color: var(--accent);">${group.icon}</span>
                                <span class="phase-title">${group.name}</span>
                                ${incompleteTasks.length > 0 ? `<span class="task-count-badge">${incompleteTasks.length}</span>` : ''}
                            </div>
                            <span class="phase-arrow">▼</span>
                        </div>
                        ${group.description || group.phone || group.hours ? `
                            <div style="padding: 12px 24px; background: var(--bg-secondary); font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                ${group.description ? `<div style="margin-bottom: 4px;">${group.description}</div>` : ''}
                                ${group.phone ? `<div style="margin-bottom: 4px;"><a href="tel:${group.phone}" style="color: var(--accent); text-decoration: none;">${group.phone}</a></div>` : ''}
                                ${group.hours ? `<div>${group.hours}</div>` : ''}
                            </div>
                        ` : ''}
                        <div class="phase-tasks">
                            ${hintCard}
                            ${renderTaskList(incompleteTasks, false, true)}
                            ${completedTasks.length > 0 ? `
                                <div class="completed-tasks-section${completedOpenClass}" data-completed-id="${group.id}" onclick="event.stopPropagation(); toggleCompletedTasks(this)">
                                    <div class="completed-tasks-header">
                                        <span>完了したタスク (${completedTasks.length})</span>
                                        <span class="completed-arrow">▼</span>
                                    </div>
                                    <div class="completed-tasks-list">
                                        ${renderTaskList(completedTasks, true, true)}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderTaskList(taskList, isDone = false, showPhaseBadge = false) {
            return taskList.map(t => {
                let checkboxDisabled = '';
                let clickHandler = `showTaskDetail('${t.id}')`;
                let extraInfo = '';
                let borderStyle = '';

                // Extract deadline from task title
                let taskTitle = t.title;
                let deadlineText = '';
                const deadlineMatch = t.title.match(/[（(]?期限[：:]\s*([^）)]+)[）)]?/);
                if (deadlineMatch) {
                    deadlineText = deadlineMatch[1].trim();
                    // Remove deadline from title for cleaner display
                    taskTitle = t.title.replace(/[（(]?期限[：:]\s*[^）)]+[）)]?/, '').trim();
                }

                // Priority表示（priority >= 85の場合のみ）
                const priorityBadge = t.priority >= 85
                    ? '<span style="display: inline-block; font-size: 10px; font-weight: 600; color: #c45a3c; background: #fef0ec; padding: 1px 6px; border-radius: 8px; margin-left: 4px;">優先</span>'
                    : '';

                if (!isDone) {
                    if (t.status === 'NEED_CONFIRM') {
                        extraInfo = '<div class="task-confirm-hint">→ 質問に回答してください</div>';
                        checkboxDisabled = 'disabled';
                        clickHandler = `openQuestionsForTask('${t.id}', 'screen-guide')`;
                    } else if (t.status === 'BLOCKED') {
                        extraInfo = '<div class="task-confirm-hint" style="color: var(--text-tertiary);">先にやることがあります</div>';
                        checkboxDisabled = 'disabled';
                        borderStyle = 'border-color: var(--border); opacity: 0.6;';
                        clickHandler = `showBlockingTask('${t.id}')`;
                    }
                }

                return `
                    <div class="task-item" style="${borderStyle}" onclick="event.stopPropagation(); ${clickHandler}">
                        <input type="checkbox" class="task-checkbox" ${isDone ? 'checked' : ''} ${checkboxDisabled} onclick="event.stopPropagation(); toggleTaskStatus('${t.id}')">
                        <div class="task-info">
                            <div class="task-name ${isDone ? 'done' : ''}">${taskTitle}${priorityBadge}</div>
                            ${deadlineText ? `<div class="task-deadline">期限: ${deadlineText}</div>` : ''}
                            ${extraInfo}
                        </div>
                        <div style="color: var(--text-tertiary); font-size: 18px;">›</div>
                    </div>
                `;
            }).join('');
        }


        function showBlockingTask(taskId) {
            // BLOCKEDタスクをタップ → 依存先タスクの詳細へ遷移
            const task = tasks.find(t => t.id === taskId);
            if (task && task.dependsOn && task.dependsOn.length > 0) {
                // 最初の依存先タスクを表示
                const blockingTaskId = task.dependsOn[0];
                showTaskDetail(blockingTaskId);
            }
        }

        function togglePhase(element) {
            element.classList.toggle('open');

            // 開閉状態を保存
            const phaseId = element.getAttribute('data-phase-id');
            if (phaseId) {
                const isOpen = element.classList.contains('open');
                const key = currentGuideView === 'phase' ? 'deadline_' + phaseId : 'dest_' + phaseId;
                window._accordionState[key] = isOpen;
            }
        }

        function toggleCompletedTasks(element) {
            element.classList.toggle('open');

            // 開閉状態を保存
            const completedId = element.getAttribute('data-completed-id');
            if (completedId) {
                const isOpen = element.classList.contains('open');
                const key = currentGuideView === 'phase' ? 'completed_deadline_' + completedId : 'completed_dest_' + completedId;
                window._accordionState[key] = isOpen;
            }
        }

        function setGuideView(view) {
            if (currentGuideView === view) return; // 既に選択中なら何もしない

            currentGuideView = view;

            // タブのアクティブ状態を更新
            const tabs = document.querySelectorAll('.guide-tabs .tab-btn');
            tabs.forEach((btn, index) => {
                btn.classList.remove('active');
                if ((view === 'phase' && index === 0) || (view === 'domain' && index === 1)) {
                    btn.classList.add('active');
                }
            });

            // コンテンツをフェードインで表示
            const container = document.getElementById('guideContent');
            container.style.opacity = '0';
            setTimeout(() => {
                renderGuide();
                container.style.transition = 'opacity 0.2s ease';
                container.style.opacity = '1';
            }, 50);
        }

        function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const currentStatus = taskStatuses[taskId];

            if (currentStatus === 'DONE') {
                // DONE → 元のステータスに戻す
                taskStatuses[taskId] = determineTaskStatus(task);
                saveData();
                // 依存タスクを再評価
                regenerateAllTaskStatuses();
                renderGuide();
                renderHome();
            } else if (currentStatus === 'OPEN') {
                // OPEN → DONEに変更
                taskStatuses[taskId] = 'DONE';
                saveData();

                // 完了数をカウント
                const doneCount = Object.values(taskStatuses).filter(s => s === 'DONE').length;

                // トースト通知
                let message = '';
                if (doneCount === 1) {
                    message = '最初の一歩を踏み出しました。その調子です。';
                } else if (doneCount === 5) {
                    message = '5つ完了しました。着実に進んでいます。';
                } else if (doneCount === 10) {
                    message = '10個のタスクを終えました。よく頑張っています。';
                } else {
                    // フェーズ内全完了チェック
                    const phaseId = task.phase;
                    const phaseTasks = tasks.filter(t => t.phase === phaseId);
                    const phaseTaskStatuses = phaseTasks.map(t => taskStatuses[t.id] || determineTaskStatus(t));
                    const phaseAllDone = phaseTaskStatuses.every(s => s === 'DONE' || s === 'NOT_APPLICABLE');
                    if (phaseAllDone) {
                        message = 'このフェーズのタスクをすべて完了しました。お疲れさまでした。';
                    }
                }

                if (message) {
                    showToast(message);
                }

                // 依存タスクを再評価
                regenerateAllTaskStatuses();
                renderGuide();
                renderHome();
            }
            // NEED_CONFIRM, BLOCKEDの場合は何もしない
        }

        function regenerateAllTaskStatuses() {
            // 全タスクのステータスを再評価（DONEは維持）
            tasks.forEach(task => {
                if (taskStatuses[task.id] !== 'DONE') {
                    taskStatuses[task.id] = determineTaskStatus(task);
                }
            });
            saveData();
        }

        // タスク詳細表示
        // 期限計算ヘルパー関数
        function calculateDeadline(phase, deathDateStr) {
            const phaseConfig = {
                'H24': { days: 0, label: '亡くなった当日中に行う手続きです' },
                'D7': { days: 7, label: '死亡日から7日以内に届出が必要です' },
                'D14': { days: 14, label: '死亡日から14日以内に届出が必要です' },
                'D49': { days: 49, label: '四十九日頃までに行う手続きです' },
                'M3': { days: 90, label: '死亡日から3ヶ月以内に届出が必要です' },
                'M4': { days: 120, label: '死亡日から4ヶ月以内に届出が必要です' },
                'M10': { days: 300, label: '死亡日から10ヶ月以内に届出が必要です' },
                'Y3': { days: 1095, label: '死亡日から3年以内に届出が必要です' }
            };

            const config = phaseConfig[phase];
            if (!config) return null;

            // 死亡日が未入力または空の場合
            if (!deathDateStr || deathDateStr.trim() === '') {
                return {
                    hasDate: false,
                    phaseLabel: config.label,
                    phaseText: phase === 'H24' ? '死亡日当日' :
                               phase === 'D7' ? '死亡日から7日以内' :
                               phase === 'D14' ? '死亡日から14日以内' :
                               phase === 'D49' ? '死亡日から49日以内' :
                               phase === 'M3' ? '死亡日から3ヶ月以内' :
                               phase === 'M4' ? '死亡日から4ヶ月以内' :
                               phase === 'M10' ? '死亡日から10ヶ月以内' :
                               '死亡日から3年以内'
                };
            }

            // 日付をパース（ISO形式 YYYY-MM-DD や YYYY/MM/DD など対応）
            let deathDate;
            try {
                // ISO形式の場合、タイムゾーン問題を避けるため手動でパース
                if (deathDateStr.includes('-')) {
                    const parts = deathDateStr.split('-');
                    deathDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else {
                    deathDate = new Date(deathDateStr);
                }

                // 無効な日付チェック
                if (isNaN(deathDate.getTime())) {
                    return {
                        hasDate: false,
                        phaseLabel: config.label,
                        phaseText: phase === 'H24' ? '死亡日当日' :
                                   phase === 'D7' ? '死亡日から7日以内' :
                                   phase === 'D14' ? '死亡日から14日以内' :
                                   phase === 'D49' ? '死亡日から49日以内' :
                                   phase === 'M3' ? '死亡日から3ヶ月以内' :
                                   phase === 'M4' ? '死亡日から4ヶ月以内' :
                                   phase === 'M10' ? '死亡日から10ヶ月以内' :
                                   '死亡日から3年以内'
                    };
                }
            } catch (e) {
                return {
                    hasDate: false,
                    phaseLabel: config.label,
                    phaseText: phase === 'H24' ? '死亡日当日' :
                               phase === 'D7' ? '死亡日から7日以内' :
                               phase === 'D14' ? '死亡日から14日以内' :
                               phase === 'D49' ? '死亡日から49日以内' :
                               phase === 'M3' ? '死亡日から3ヶ月以内' :
                               phase === 'M4' ? '死亡日から4ヶ月以内' :
                               phase === 'M10' ? '死亡日から10ヶ月以内' :
                               '死亡日から3年以内'
                };
            }

            const deadlineDate = new Date(deathDate);
            deadlineDate.setDate(deadlineDate.getDate() + config.days);

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadline = new Date(deadlineDate);
            deadline.setHours(0, 0, 0, 0);

            const diffTime = deadline - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const year = deadlineDate.getFullYear();
            const month = deadlineDate.getMonth() + 1;
            const day = deadlineDate.getDate();
            const dateStr = `${year}年${month}月${day}日`;

            return {
                hasDate: true,
                dateStr: dateStr,
                daysRemaining: diffDays,
                phaseLabel: config.label,
                isOverdue: diffDays < 0
            };
        }

        function showTaskDetail(taskId) {
            // ガイド画面のスクロール位置を保存
            const guideScreen = document.getElementById('screen-guide');
            if (guideScreen) {
                window._guideScrollTop = guideScreen.scrollTop;
            }

            currentTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            const detail = taskDetails[taskId];
            const status = taskStatuses[taskId] || determineTaskStatus(task);

            // ステップ進捗状態を読み込み
            const stepProgress = JSON.parse(localStorage.getItem('rn_step_progress') || '{}');
            window._currentStepProgress = stepProgress[taskId] || [];

            let html = '';

            // タイトルエリア
            let statusBadgeClass = 'open';
            let statusText = 'やること';
            if (status === 'DONE') {
                statusBadgeClass = 'done';
                statusText = '完了';
            } else if (status === 'NEED_CONFIRM') {
                statusBadgeClass = 'confirm';
                statusText = '確認が必要';
            } else if (status === 'BLOCKED') {
                statusBadgeClass = 'blocked';
                statusText = 'ブロック中';
            }

            html += `<div class="detail-title-area">
                <div class="detail-task-title">${task.title}</div>
                <div class="detail-status-badge ${statusBadgeClass}">${statusText}</div>
            </div>`;

            if (detail) {
                // 概要テキスト（プレーン）
                if (detail.actionSummary) {
                    html += `<div class="detail-summary-text">${detail.actionSummary}</div>`;
                }

                // 期限表示（完了済みでない場合のみ）
                if (status !== 'DONE' && task.phase) {
                    const savedAnswers = JSON.parse(localStorage.getItem('answers') || '{}');
                    const deathDate = savedAnswers['Q-DOD-01'];

                    // デバッグ用（開発時のみ表示）
                    console.log('期限計算 - タスクID:', taskId, 'Phase:', task.phase, '死亡日:', deathDate);

                    const deadlineInfo = calculateDeadline(task.phase, deathDate);

                    if (deadlineInfo) {
                        if (deadlineInfo.hasDate) {
                            const isOverdue = deadlineInfo.isOverdue;
                            const daysRemaining = deadlineInfo.daysRemaining;
                            let remainingClass = 'detail-deadline-remaining';
                            let remainingText = '';
                            let wrapperClass = 'detail-deadline';

                            if (isOverdue) {
                                remainingClass += ' overdue';
                                remainingText = `（${Math.abs(daysRemaining)}日超過）`;
                                wrapperClass += ' overdue-warning';
                            } else if (daysRemaining <= 7) {
                                remainingClass += ' urgent';
                                remainingText = `（あと${daysRemaining}日）`;
                                wrapperClass += ' urgent-warning';
                            } else if (daysRemaining <= 14) {
                                remainingClass += ' soon';
                                remainingText = `（あと${daysRemaining}日）`;
                                wrapperClass += ' soon-warning';
                            } else {
                                remainingText = `（あと${daysRemaining}日）`;
                            }

                            html += `<div class="${wrapperClass}">
                                <div class="detail-deadline-main">
                                    <span class="detail-deadline-label">期限: </span>
                                    <span class="detail-deadline-date">${deadlineInfo.dateStr}</span>
                                    <span class="${remainingClass}">${remainingText}</span>
                                </div>
                                <div class="detail-deadline-sub">
                                    ${isOverdue ? '期限を過ぎていますが、届出は可能です。早めに手続きしましょう。' : deadlineInfo.phaseLabel}
                                </div>
                            </div>`;
                        } else {
                            html += `<div class="detail-deadline no-date">
                                <div class="detail-deadline-main">
                                    <span class="detail-deadline-label">期限: </span>${deadlineInfo.phaseText}
                                </div>
                                <div class="detail-deadline-sub link" onclick="showScreen('screen-confirm')">
                                    死亡日を入力すると具体的な期限が表示されます
                                </div>
                            </div>`;
                        }
                    }
                }

                // なぜ必要か
                if (detail.whyNeeded && detail.whyNeeded !== '—') {
                    html += `
                        <div class="detail-section">
                            <div class="detail-section-header">なぜ必要か</div>
                            <div class="detail-white-card">
                                <div class="detail-why-text">${detail.whyNeeded}</div>
                            </div>
                        </div>
                    `;
                }

                // 届出先
                if (detail.destination && detail.destination !== '—' && detail.destination.trim() !== '') {
                    html += `
                        <div class="detail-section">
                            <div class="detail-section-header">届出先</div>
                            <div class="detail-white-card">
                                <div class="detail-dest-name">${detail.destination}</div>
                                ${detail.address && detail.address.trim() !== '' ? `<div class="detail-dest-address">${detail.address}</div>` : ''}
                                ${detail.phone && detail.phone.trim() !== '' ? `<a href="tel:${detail.phone}" class="detail-dest-phone">${detail.phone}</a>` : ''}
                                ${detail.officeHours && detail.officeHours.trim() !== '' ? `<div class="detail-dest-hours">${detail.officeHours}</div>` : ''}
                            </div>
                        </div>
                    `;
                }

                // 必要なもの
                if (detail.requiredDocs && detail.requiredDocs !== '—') {
                    const docs = detail.requiredDocs === 'なし' ? '特になし' : detail.requiredDocs;
                    const docsList = docs.split(/[、・]/).filter(d => d.trim() !== '');
                    html += `
                        <div class="detail-section">
                            <div class="detail-section-header">必要なもの</div>
                            <div class="detail-white-card">
                                <ul class="detail-docs-list">
                                    ${docsList.map(doc => `<li>${doc.trim()}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                // やること（手順）
                if (detail.steps && detail.steps !== '—') {
                    const stepsList = detail.steps.split(/(?=[①②③④⑤⑥⑦⑧⑨⑩])/).filter(s => s.trim() !== '');
                    if (stepsList.length > 0) {
                        html += `
                            <div class="detail-section">
                                <div class="detail-section-header">やること</div>
                                <div class="detail-white-card">
                                    <div class="detail-steps-list">
                                        ${stepsList.map((step, index) => {
                                            let stepText = step.replace(/^[①②③④⑤⑥⑦⑧⑨⑩]/, '').trim();
                                            stepText = stepText.replace(/\/\s*$/, '').trim();
                                            const isCompleted = window._currentStepProgress[index] || false;
                                            const completedClass = isCompleted ? ' completed' : '';
                                            return `
                                                <div class="detail-step-item${completedClass}" data-step-index="${index}">
                                                    <input type="checkbox" class="detail-step-checkbox" ${isCompleted ? 'checked' : ''}
                                                           onclick="toggleStepComplete('${taskId}', ${index})">
                                                    <div class="detail-step-number">${index + 1}</div>
                                                    <div class="detail-step-text">${stepText}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                // 完了の目安
                if (detail.doneCondition && detail.doneCondition !== '—') {
                    html += `
                        <div class="detail-section">
                            <div class="detail-section-header">完了の目安</div>
                            <div class="detail-white-card">
                                <div class="detail-done-text">${detail.doneCondition}</div>
                            </div>
                        </div>
                    `;
                }

                // よくある質問
                if (detail.faq && detail.faq !== '—') {
                    const faqList = detail.faq.split(/(?=Q\.)/).filter(f => f.trim() !== '');
                    if (faqList.length > 0) {
                        html += `
                            <div class="detail-section">
                                <div class="detail-section-header">よくある質問</div>
                                <div class="detail-white-card">
                                    ${faqList.map(faqItem => {
                                        const parts = faqItem.split('→');
                                        if (parts.length >= 2) {
                                            const question = parts[0].trim();
                                            let answer = parts.slice(1).join('→').trim();
                                            // 末尾のスラッシュを除去
                                            answer = answer.replace(/\/\s*$/, '').trim();
                                            return `
                                                <div class="detail-faq-item" onclick="toggleFAQ(this)">
                                                    <div class="detail-faq-question">
                                                        <span>${question}</span>
                                                        <span class="detail-faq-arrow">▼</span>
                                                    </div>
                                                    <div class="detail-faq-answer">${answer}</div>
                                                </div>
                                            `;
                                        }
                                        return '';
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
            } else {
                // 準備中
                html += `
                    <div class="detail-summary-card">
                        <div class="detail-preparing">詳細情報は現在準備中です。</div>
                    </div>
                `;
            }

            document.getElementById('detailContent').innerHTML = html;

            // 完了ボタンの設定
            const completeBtn = document.getElementById('completeBtn');
            completeBtn.className = 'btn-complete';

            if (status === 'DONE') {
                completeBtn.textContent = '完了済み ✓';
                completeBtn.classList.add('done');
                completeBtn.disabled = false;
            } else if (status === 'OPEN') {
                completeBtn.textContent = '完了にする';
                completeBtn.classList.add('active');
                completeBtn.disabled = false;
            } else if (status === 'BLOCKED') {
                completeBtn.textContent = '先にやることがあります';
                completeBtn.classList.add('done');
                completeBtn.disabled = true;
            } else if (status === 'NEED_CONFIRM') {
                completeBtn.textContent = '確認が必要です';
                completeBtn.classList.add('done');
                completeBtn.disabled = true;
            } else {
                completeBtn.textContent = '完了にする';
                completeBtn.classList.add('active');
                completeBtn.disabled = false;
            }

            showScreen('screen-detail');
        }

        function completeCurrentTask() {
            if (currentTaskId) {
                toggleTaskStatus(currentTaskId);
                showScreen('screen-guide');
            }
        }

        function toggleStepComplete(taskId, stepIndex) {
            const stepProgress = JSON.parse(localStorage.getItem('rn_step_progress') || '{}');
            if (!stepProgress[taskId]) {
                stepProgress[taskId] = [];
            }

            // チェック状態をトグル
            stepProgress[taskId][stepIndex] = !stepProgress[taskId][stepIndex];
            localStorage.setItem('rn_step_progress', JSON.stringify(stepProgress));

            // UI更新
            const stepItem = document.querySelector(`.detail-step-item[data-step-index="${stepIndex}"]`);
            if (stepItem) {
                if (stepProgress[taskId][stepIndex]) {
                    stepItem.classList.add('completed');
                } else {
                    stepItem.classList.remove('completed');
                }
            }

            // グローバル変数も更新
            window._currentStepProgress = stepProgress[taskId];
        }

        function toggleFAQ(element) {
            const isOpen = element.classList.contains('open');

            if (isOpen) {
                // 閉じる
                element.classList.remove('open');
            } else {
                // 開く
                element.classList.add('open');
            }
        }

        // NEED_CONFIRMタスク用: 未回答質問を取得
        function getUnansweredQuestionsForTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.requiredQuestions || task.requiredQuestions.length === 0) return [];
            const currentAnswers = JSON.parse(localStorage.getItem('answers') || '{}');
            return task.requiredQuestions.filter(qId => !currentAnswers[qId]);
        }

        // NEED_CONFIRMタスクをタップ時の処理
        function openQuestionsForTask(taskId, returnScreen) {
            const unanswered = getUnansweredQuestionsForTask(taskId);
            if (unanswered.length === 0) {
                // 未回答なし → 通常のタスク詳細へ
                showTaskDetail(taskId);
                return;
            }
            // 未回答の質問だけをフィルタして確認センターを開く
            showFilteredQuestions(unanswered, returnScreen, taskId);
        }

        // フィルタ付き確認センター表示
        function showFilteredQuestions(questionIds, returnScreen, taskId) {
            const filteredQuestions = questions.filter(q => questionIds.includes(q.id));
            if (filteredQuestions.length === 0) return;

            // フィルタモードの状態変数を設定
            window._filteredMode = true;
            window._filteredQuestions = filteredQuestions;
            window._filteredReturnScreen = returnScreen || 'screen-guide';
            window._filteredCurrentIndex = 0;
            window._filteredTaskId = taskId || null;

            // 確認センターを表示
            startConfirmCenter(returnScreen);
        }

        // 確認センター（新実装：1画面1質問）
        function startConfirmCenter(sourceScreen = 'screen-home') {
            // フィルタモードかどうかで分岐
            if (window._filteredMode === true && window._filteredQuestions) {
                // フィルタモード: 指定された質問のみ表示
                confirmQuestions = window._filteredQuestions;
                currentConfirmIndex = window._filteredCurrentIndex || 0;
                confirmSourceScreen = window._filteredReturnScreen || sourceScreen;
                confirmTaskId = window._filteredTaskId || null;
            } else {
                // 通常モード: 確認センター用の質問（オンボーディング済み7問を除く残り19問）
                confirmQuestions = questions.filter(q => !onboardingQuestionIds.includes(q.id));

                // 最初の未回答質問を探す
                const firstUnansweredIndex = confirmQuestions.findIndex(q => !answers[q.id] || answers[q.id].length === 0);
                currentConfirmIndex = firstUnansweredIndex >= 0 ? firstUnansweredIndex : 0;

                confirmSourceScreen = sourceScreen;
                confirmTaskId = null; // 全質問表示の場合はnull
            }

            confirmDirection = 'forward';

            renderConfirmQuestion();
            updateConfirmProgress();

            // 完了画面を非表示
            document.getElementById('confirmCompletionScreen').style.display = 'none';
            document.getElementById('confirmQuestionArea').style.display = 'block';

            // 画面5を表示
            showScreen('screen-confirm');
        }

        function renderConfirmQuestion() {
            const q = confirmQuestions[currentConfirmIndex];
            const container = document.getElementById('confirmQuestionArea');

            const slideClass = confirmDirection === 'forward' ? 'confirm-question-slide' : 'confirm-question-slide-left';

            let html = `<div class="${slideClass}">`;
            html += `<div class="question-card">`;
            html += `<div class="domain-badge domain-${q.domain}">${domainLabels[q.domain]}</div>`;
            html += `<div class="question-text">${q.text}</div>`;
            html += `<div class="question-info">※後から変更できます</div>`;

            if (q.type === 'single') {
                q.options.forEach(opt => {
                    const selected = answers[q.id] === opt.value ? 'selected' : '';
                    html += `<button class="option-btn ${selected}" onclick="selectSingleConfirm('${q.id}', '${opt.value}')">${opt.label}</button>`;
                });
                html += `<a class="skip-link" onclick="skipConfirmQuestion()">あとで回答する</a>`;
            } else if (q.type === 'multi') {
                q.options.forEach(opt => {
                    const selected = answers[q.id] && answers[q.id].includes(opt.value) ? 'selected' : '';
                    html += `<button class="option-btn ${selected}" onclick="selectMultiConfirm('${q.id}', '${opt.value}')">${opt.label}</button>`;
                });

                const isLastQuestion = currentConfirmIndex === confirmQuestions.length - 1;
                const hasSelection = answers[q.id] && answers[q.id].length > 0;
                const btnText = isLastQuestion ? '完了' : '次へ';
                const btnDisabled = hasSelection ? '' : 'disabled';
                const btnStyle = hasSelection ? '' : 'style="opacity: 0.3; pointer-events: none;"';

                html += `<button class="btn-primary" id="confirmNextBtn" onclick="nextConfirmQuestion()" ${btnDisabled} ${btnStyle} style="margin-top: 32px;">${btnText}</button>`;
                html += `<a class="skip-link" onclick="skipConfirmQuestion()" style="margin-top: 16px; display: block;">あとで回答する</a>`;
            } else if (q.type === 'date') {
                const value = answers[q.id] || '';
                html += `<input type="date" class="date-input" id="confirmDateInput" value="${value}" onchange="selectDateConfirm('${q.id}', this.value)">`;

                const isLastQuestion = currentConfirmIndex === confirmQuestions.length - 1;
                const hasDate = answers[q.id] && answers[q.id].trim() !== '';
                const btnText = isLastQuestion ? '完了' : '次へ';
                const btnDisabled = hasDate ? '' : 'disabled';
                const btnStyle = hasDate ? '' : 'style="opacity: 0.3; pointer-events: none;"';

                html += `<button class="btn-primary" id="confirmNextBtn" onclick="nextConfirmQuestion()" ${btnDisabled} ${btnStyle} style="margin-top: 32px;">${btnText}</button>`;
                html += `<a class="skip-link" onclick="skipConfirmQuestion()" style="margin-top: 16px; display: block;">あとで回答する</a>`;
            }

            html += `</div></div>`;
            container.innerHTML = html;
        }

        function updateConfirmProgress() {
            const progressPercent = ((currentConfirmIndex + 1) / confirmQuestions.length) * 100;
            document.getElementById('confirmProgressFill').style.width = progressPercent + '%';
            document.getElementById('confirmProgressText').textContent = `${currentConfirmIndex + 1} / ${confirmQuestions.length}`;
        }

        function selectSingleConfirm(qid, value) {
            answers[qid] = value;
            saveData();
            regenerateAllTaskStatuses();
            nextConfirmQuestion();
        }

        function selectMultiConfirm(qid, value) {
            if (!answers[qid]) answers[qid] = [];

            if (value === 'NONE' || value === 'UNKNOWN') {
                answers[qid] = [value];
            } else {
                answers[qid] = answers[qid].filter(v => v !== 'NONE' && v !== 'UNKNOWN');
                const index = answers[qid].indexOf(value);
                if (index > -1) {
                    answers[qid].splice(index, 1);
                } else {
                    answers[qid].push(value);
                }
            }

            saveData();
            regenerateAllTaskStatuses();
            renderConfirmQuestion();
        }

        function selectDateConfirm(qid, value) {
            answers[qid] = value;
            saveData();
            regenerateAllTaskStatuses();
            renderConfirmQuestion();
        }

        function nextConfirmQuestion() {
            confirmDirection = 'forward';
            if (currentConfirmIndex < confirmQuestions.length - 1) {
                currentConfirmIndex++;
                renderConfirmQuestion();
                updateConfirmProgress();
            } else {
                // 完了画面を表示
                const completionScreen = document.getElementById('confirmCompletionScreen');
                document.getElementById('confirmQuestionArea').style.display = 'none';

                // フィルタモードをクリア
                const isFilteredMode = window._filteredMode === true;
                if (isFilteredMode) {
                    window._filteredMode = false;
                    window._filteredQuestions = null;
                    window._filteredReturnScreen = null;
                    window._filteredCurrentIndex = 0;
                    window._filteredTaskId = null;
                }

                // 完了画面のテキストを動的に変更
                if (isFilteredMode || confirmTaskId) {
                    // フィルタモード（NEED_CONFIRMタスクから遷移）の場合
                    completionScreen.innerHTML = `
                        <div class="confirm-completion-content">
                            <div class="heading-lg" style="text-align: center; margin-bottom: 16px;">回答が完了しました</div>
                            <div class="body-sm" style="text-align: center; color: var(--text-secondary); margin-bottom: 40px;">タスクのステータスが更新されます</div>
                            <button class="btn-primary" onclick="showScreen('${confirmSourceScreen}')">戻る</button>
                        </div>
                    `;
                } else {
                    // 通常モード（確認センターから直接開いた場合）
                    completionScreen.innerHTML = `
                        <div class="confirm-completion-content">
                            <div class="heading-lg" style="text-align: center; margin-bottom: 16px;">確認が完了しました</div>
                            <div class="body-sm" style="text-align: center; color: var(--text-secondary); margin-bottom: 40px;">回答内容はいつでも変更できます</div>
                            <button class="btn-primary" onclick="showScreen('${confirmSourceScreen}')">ホームへ戻る</button>
                        </div>
                    `;
                }

                completionScreen.style.display = 'flex';
            }
        }

        function prevConfirmQuestion() {
            if (currentConfirmIndex > 0) {
                confirmDirection = 'back';
                currentConfirmIndex--;
                renderConfirmQuestion();
                updateConfirmProgress();
            } else {
                // 1問目の場合は遷移元の画面へ戻る
                // フィルタモードをクリア
                if (window._filteredMode === true) {
                    window._filteredMode = false;
                    window._filteredQuestions = null;
                    window._filteredReturnScreen = null;
                    window._filteredCurrentIndex = 0;
                    window._filteredTaskId = null;
                }
                showScreen(confirmSourceScreen);
            }
        }

        function skipConfirmQuestion() {
            nextConfirmQuestion();
        }

        function exitConfirmCenter() {
            // フィルタモードをクリア
            if (window._filteredMode === true) {
                window._filteredMode = false;
                window._filteredQuestions = null;
                window._filteredReturnScreen = null;
                window._filteredCurrentIndex = 0;
                window._filteredTaskId = null;
            }
            showScreen(confirmSourceScreen);
        }

        // カレンダー機能
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth();
        let selectedDate = null;

        function showCalendar() {
            // 死亡日が入力されているか確認
            const deathDate = answers['Q-DOD-01'];
            const noDateMessage = document.getElementById('calendarNoDateMessage');
            const calendarContainer = document.getElementById('calendarContainer');
            const overdueTasksSummary = document.getElementById('overdueTasksSummary');

            if (!deathDate) {
                noDateMessage.style.display = 'block';
                calendarContainer.style.display = 'none';
                overdueTasksSummary.style.display = 'none';
            } else {
                noDateMessage.style.display = 'none';
                calendarContainer.style.display = 'block';

                // 現在の年月でカレンダーを表示
                currentCalendarYear = new Date().getFullYear();
                currentCalendarMonth = new Date().getMonth();
                renderCalendar();

                // 期限切れタスクをチェック
                checkOverdueTasks();
            }

            showScreen('screen-calendar');
        }

        function goToDeathDateQuestion() {
            // Q-DOD-01に直接遷移
            const dodQuestion = questions.find(q => q.id === 'Q-DOD-01');
            if (dodQuestion) {
                showFilteredQuestions(['Q-DOD-01'], 'screen-calendar', null);
            }
        }

        function changeMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            } else if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            renderCalendar();
        }

        function renderCalendar() {
            // 月ラベル更新
            const monthLabel = document.getElementById('calendarMonthLabel');
            monthLabel.textContent = `${currentCalendarYear}年${currentCalendarMonth + 1}月`;

            // カレンダーグリッドを生成
            const datesContainer = document.getElementById('calendarDates');
            datesContainer.innerHTML = '';

            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 前月の日付を埋める
            const prevMonthLastDay = new Date(currentCalendarYear, currentCalendarMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay.getDate() - i;
                const cell = createDateCell(day, true, null);
                datesContainer.appendChild(cell);
            }

            // 当月の日付
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentCalendarYear, currentCalendarMonth, day);
                date.setHours(0, 0, 0, 0);
                const isToday = date.getTime() === today.getTime();
                const isPast = date < today;
                const cell = createDateCell(day, false, date, isToday, isPast);
                datesContainer.appendChild(cell);
            }

            // 次月の日付を埋める
            const totalCells = datesContainer.children.length;
            const remainingCells = 42 - totalCells; // 6週間分
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDateCell(day, true, null);
                datesContainer.appendChild(cell);
            }
        }

        function createDateCell(day, isOtherMonth, date, isToday = false, isPast = false) {
            const cell = document.createElement('div');
            cell.className = 'calendar-date-cell';
            if (isOtherMonth) cell.classList.add('other-month');
            if (isPast && !isOtherMonth) cell.classList.add('past');
            if (isToday) cell.classList.add('today');

            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-date-number';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);

            // タスクのドットインジケーター
            if (!isOtherMonth && date) {
                const tasksForDate = getTasksForDate(date);
                if (tasksForDate.length > 0) {
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'calendar-date-dots';

                    // タスクの状態を判定
                    const hasOverdue = tasksForDate.some(t => {
                        const status = taskStatuses[t.id] || determineTaskStatus(t);
                        return status !== 'DONE' && date < new Date();
                    });
                    const allDone = tasksForDate.every(t => {
                        const status = taskStatuses[t.id] || determineTaskStatus(t);
                        return status === 'DONE';
                    });

                    // ドット数を決定
                    const dotCount = tasksForDate.length >= 3 ? 2 : 1;
                    for (let i = 0; i < dotCount; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'calendar-dot';
                        if (hasOverdue) {
                            dot.classList.add('overdue');
                        } else if (allDone) {
                            dot.classList.add('done');
                        }
                        dotsContainer.appendChild(dot);
                    }

                    cell.appendChild(dotsContainer);
                }

                // タップイベント
                cell.onclick = () => selectCalendarDate(date);
            }

            return cell;
        }

        function getTasksForDate(date) {
            const deathDate = answers['Q-DOD-01'];
            if (!deathDate) return [];

            const death = new Date(deathDate);
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);

            return tasks.filter(task => {
                // NOT_APPLICABLEは除外
                const status = taskStatuses[task.id] || determineTaskStatus(task);
                if (status === 'NOT_APPLICABLE') return false;

                const deadline = getTaskDeadline(task, death);
                if (!deadline) return false;

                deadline.setHours(0, 0, 0, 0);
                return deadline.getTime() === targetDate.getTime();
            });
        }

        function getTaskDeadline(task, deathDate) {
            const death = new Date(deathDate);
            const deadline = new Date(death);

            switch (task.phase) {
                case 'H24':
                    deadline.setDate(death.getDate() + 1);
                    break;
                case 'D7':
                    deadline.setDate(death.getDate() + 7);
                    break;
                case 'D14':
                    deadline.setDate(death.getDate() + 14);
                    break;
                case 'D49':
                    deadline.setDate(death.getDate() + 49);
                    break;
                case 'M3':
                    deadline.setMonth(death.getMonth() + 3);
                    break;
                case 'M4':
                    deadline.setMonth(death.getMonth() + 4);
                    break;
                case 'M10':
                    deadline.setMonth(death.getMonth() + 10);
                    break;
                case 'Y3':
                    deadline.setFullYear(death.getFullYear() + 3);
                    break;
                default:
                    return null;
            }

            return deadline;
        }

        function selectCalendarDate(date) {
            selectedDate = date;

            // 選択状態を更新
            document.querySelectorAll('.calendar-date-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // タスクリストを表示
            const tasksForDate = getTasksForDate(date);
            const selectedDateTasks = document.getElementById('selectedDateTasks');
            const selectedDateHeader = document.getElementById('selectedDateHeader');
            const selectedDateTasksList = document.getElementById('selectedDateTasksList');

            // 日付ヘッダーを更新
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            const weekday = weekdays[date.getDay()];
            selectedDateHeader.textContent = `${month}月${day}日（${weekday}）のタスク`;

            if (tasksForDate.length === 0) {
                selectedDateTasksList.innerHTML = '<div class="selected-date-no-tasks">この日に期限のタスクはありません</div>';
            } else {
                selectedDateTasksList.innerHTML = renderTaskList(tasksForDate.map(t => ({
                    ...t,
                    status: taskStatuses[t.id] || determineTaskStatus(t)
                })), false, true);
            }

            selectedDateTasks.style.display = 'block';
        }

        function checkOverdueTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const deathDate = answers['Q-DOD-01'];
            if (!deathDate) return;

            const death = new Date(deathDate);

            const overdueTasks = tasks.filter(task => {
                const status = taskStatuses[task.id] || determineTaskStatus(task);
                if (status === 'DONE' || status === 'NOT_APPLICABLE') return false;

                const deadline = getTaskDeadline(task, death);
                if (!deadline) return false;

                deadline.setHours(0, 0, 0, 0);
                return deadline < today;
            });

            const overdueTasksSummary = document.getElementById('overdueTasksSummary');
            const overdueText = document.getElementById('overdueText');

            if (overdueTasks.length > 0) {
                overdueText.textContent = `期限を過ぎたタスクが${overdueTasks.length}件あります`;
                overdueTasksSummary.style.display = 'flex';
            } else {
                overdueTasksSummary.style.display = 'none';
            }
        }

        function toggleOverdueTasks() {
            const overdueTasksList = document.getElementById('overdueTasksList');
            const isVisible = overdueTasksList.style.display === 'block';

            if (isVisible) {
                overdueTasksList.style.display = 'none';
            } else {
                // 期限切れタスクを取得
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const deathDate = answers['Q-DOD-01'];
                const death = new Date(deathDate);

                const overdueTasks = tasks.filter(task => {
                    const status = taskStatuses[task.id] || determineTaskStatus(task);
                    if (status === 'DONE' || status === 'NOT_APPLICABLE') return false;

                    const deadline = getTaskDeadline(task, death);
                    if (!deadline) return false;

                    deadline.setHours(0, 0, 0, 0);
                    return deadline < today;
                }).map(t => ({
                    ...t,
                    status: taskStatuses[t.id] || determineTaskStatus(t)
                }));

                overdueTasksList.innerHTML = renderTaskList(overdueTasks, false, true);
                overdueTasksList.style.display = 'block';
            }
        }

        // ユーティリティ
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function toggleQA(element) {
            element.classList.toggle('open');
        }

        // 名前入力関連

        // ユーザー名の表示を更新
        function updateUserNameDisplay() {
            const userName = localStorage.getItem('rn_user_name') || 'ゲスト';
            // ホーム画面の名前表示
            const headerNameEl = document.querySelector('.header-name');
            if (headerNameEl) {
                headerNameEl.textContent = userName + 'さん';
            }
            // 設定画面の名前表示
            const displayUserNameEl = document.getElementById('displayUserName');
            if (displayUserNameEl) {
                displayUserNameEl.textContent = userName + 'さん';
            }
        }

        // 名前変更モーダル
        function showEditNameModal() {
            const modal = document.getElementById('editNameModal');
            const input = document.getElementById('editNameInput');
            const currentName = localStorage.getItem('rn_user_name') || 'ゲスト';
            input.value = currentName;
            modal.classList.add('show');
            setTimeout(() => input.focus(), 100);
        }

        function closeEditNameModal() {
            const modal = document.getElementById('editNameModal');
            modal.classList.remove('show');
        }

        function saveEditedName() {
            const input = document.getElementById('editNameInput');
            const newName = input.value.trim();
            if (newName) {
                localStorage.setItem('rn_user_name', newName);
                updateUserNameDisplay();
                closeEditNameModal();
                showToast('名前を変更しました');
            }
        }

        // モーダルの外側クリックで閉じる
        document.addEventListener('click', (e) => {
            const editNameModal = document.getElementById('editNameModal');
            if (e.target === editNameModal) {
                closeEditNameModal();
            }
        });

        // ログアウト関連
        function showLogoutDialog() {
            const dialog = document.getElementById('logoutDialog');
            dialog.classList.add('show');
        }

        function closeLogoutDialog() {
            const dialog = document.getElementById('logoutDialog');
            dialog.classList.remove('show');
        }

        function confirmLogout() {
            const STORAGE_KEYS = [
                'rn_user_name',
                'answers',
                'taskStatuses',
                'rn_step_progress',
                'rn_done_tasks',
                'rn_task_notes'
            ];
            STORAGE_KEYS.forEach(key => localStorage.removeItem(key));

            // アコーディオン状態とスクロール位置をクリア
            window._accordionState = {};
            window._guideScrollTop = 0;

            closeLogoutDialog();
            showScreen('screen-splash');
            showToast('ログアウトしました');
        }

        // 回答リセット関連
        function resetAnswers() {
            const dialog = document.getElementById('resetDialog');
            dialog.classList.add('show');
        }

        function closeResetDialog() {
            const dialog = document.getElementById('resetDialog');
            dialog.classList.remove('show');
        }

        function confirmResetAnswers() {
            localStorage.removeItem('answers');
            answers = {};

            // アコーディオン状態とスクロール位置もクリア
            window._accordionState = {};
            window._guideScrollTop = 0;

            closeResetDialog();
            currentQuestionIndex = 0;
            showScreen('screen-onboarding');
            renderQuestion();
            showToast('回答をリセットしました');
        }

        // 初期化
        window.addEventListener('load', () => {
            loadData();

            const userName = localStorage.getItem('rn_user_name');
            const hasAnswers = Object.keys(answers).length > 0;

            if (userName && hasAnswers) {
                // 名前 + 回答済み → ホーム画面
                generateTasks();
                updateUserNameDisplay();
                renderHome();
                showScreen('screen-home');
            } else if (userName && !hasAnswers) {
                // 名前あり、質問未回答 → 質問画面（名前入力スキップして質問から開始）
                generateTasks();
                updateUserNameDisplay();
                onboardingQuestions = questions.filter(q => onboardingQuestionIds.includes(q.id));
                onboardingQuestions.sort((a, b) => {
                    return onboardingQuestionIds.indexOf(a.id) - onboardingQuestionIds.indexOf(b.id);
                });
                currentQuestionIndex = 0; // Start from first question, skip name input
                showScreen('screen-onboarding');
                renderQuestion();
            } else {
                // 初回 → スプラッシュ画面
                generateTasks();
                showScreen('screen-splash');
            }
        });
    </script>
</body>
</html>
